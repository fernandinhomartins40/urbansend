# üê≥ UrbanSend - Docker Compose (Container √önico)
# VPS: 72.60.10.112

version: '3.8'

services:
  urbansend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: urbansend-app
    restart: unless-stopped
    
    ports:
      - "3010:3010"    # Aplica√ß√£o principal (HTTP)
      - "25:25"        # SMTP Server
    
    volumes:
      # Dados persistentes
      - urbansend_data:/app/data
      - urbansend_logs:/app/logs
      
      # Configura√ß√µes (opcional - para desenvolvimento)
      - ./docker/.env.production:/app/.env:ro
      
    environment:
      - NODE_ENV=production
      - TZ=America/Sao_Paulo
      
    networks:
      - urbansend-network
      
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
      
    # Limita√ß√µes de recursos
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    
    # Labels para organiza√ß√£o
    labels:
      - "com.urbansend.service=main"
      - "com.urbansend.version=1.0.0"
      - "com.urbansend.description=UrbanSend Email Transactional Platform"

# === VOLUMES PERSISTENTES ===
volumes:
  urbansend_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data
      
  urbansend_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/logs

# === NETWORK ===
networks:
  urbansend-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16