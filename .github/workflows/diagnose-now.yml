name: ðŸ” Diagnose VPS Issues Now

on:
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.112'
  VPS_USER: 'root'
  APP_DIR: '/var/www/urbansend'

jobs:
  diagnose:
    name: ðŸ” Emergency Diagnosis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ”§ Setup SSH
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

    - name: ðŸ” Full System Diagnosis
      run: |
        echo "ðŸ” DIAGNÃ“STICO COMPLETO DA VPS"
        echo "=============================="
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'ðŸ“‹ 1. INFORMAÃ‡Ã•ES DO SISTEMA:'
        echo 'Hostname:' \$(hostname)
        echo 'Uptime:' \$(uptime)
        echo 'Date:' \$(date)
        echo ''
        
        echo 'ðŸ³ 2. STATUS DO DOCKER:'
        if command -v docker >/dev/null; then
          echo 'âœ… Docker instalado'
          docker --version
          echo 'Docker status:' \$(systemctl is-active docker)
          echo ''
          echo 'Containers em execuÃ§Ã£o:'
          docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
          echo ''
          echo 'Todas as imagens:'
          docker images --format 'table {{.Repository}}\t{{.Tag}}\t{{.Size}}'
        else
          echo 'âŒ Docker NÃƒO instalado'
        fi
        echo ''
        
        echo 'ðŸ“ 3. CONTEÃšDO DO DIRETÃ“RIO DA APLICAÃ‡ÃƒO:'
        if [ -d '${{ env.APP_DIR }}' ]; then
          echo 'âœ… DiretÃ³rio existe: ${{ env.APP_DIR }}'
          ls -la ${{ env.APP_DIR }}
          echo ''
          if [ -f '${{ env.APP_DIR }}/docker-compose.production.yml' ]; then
            echo 'âœ… docker-compose.production.yml encontrado'
            echo 'ConteÃºdo (primeiras 20 linhas):'
            head -20 ${{ env.APP_DIR }}/docker-compose.production.yml
          else
            echo 'âŒ docker-compose.production.yml NÃƒO encontrado'
          fi
        else
          echo 'âŒ DiretÃ³rio NÃƒO existe: ${{ env.APP_DIR }}'
        fi
        echo ''
        
        echo 'ðŸŒ 4. PORTAS EM USO:'
        netstat -tlnp | grep -E ':(3010|25|6379|80|443)' || echo 'Nenhuma das portas esperadas estÃ¡ em uso'
        echo ''
        
        echo 'ðŸ”¥ 5. STATUS DO FIREWALL:'
        if command -v ufw >/dev/null; then
          echo 'âœ… UFW instalado'
          ufw status verbose
        else
          echo 'âŒ UFW nÃ£o instalado'
        fi
        echo ''
        echo 'Regras iptables bÃ¡sicas:'
        iptables -L INPUT -n | head -10
        echo ''
        
        echo 'ðŸ’¾ 6. RECURSOS DO SISTEMA:'
        echo 'MemÃ³ria:'
        free -h
        echo 'Disco:'
        df -h /
        echo 'CPU Load:'
        cat /proc/loadavg
        echo ''
        
        echo 'ðŸ“ 7. LOGS RECENTES:'
        if [ -d '${{ env.APP_DIR }}' ]; then
          cd '${{ env.APP_DIR }}'
          echo 'Status do docker-compose:'
          docker compose -f docker-compose.production.yml ps 2>/dev/null || echo 'docker-compose nÃ£o funcionando'
          echo ''
          echo 'Logs dos containers (Ãºltimas 20 linhas):'
          docker compose -f docker-compose.production.yml logs --tail=20 2>/dev/null || echo 'Sem logs de containers'
        fi
        echo ''
        
        echo 'ðŸ” 8. CONECTIVIDADE INTERNA:'
        echo 'Testando localhost:3010 internamente:'
        curl -v --connect-timeout 5 http://localhost:3010/health 2>&1 || echo 'Falha na conexÃ£o interna'
        echo ''
        
        echo 'âœ… DIAGNÃ“STICO COMPLETO'
        "

    - name: ðŸ“Š Show Diagnosis Summary
      run: |
        echo "ðŸŽ¯ PRÃ“XIMOS PASSOS BASEADOS NO DIAGNÃ“STICO:"
        echo ""
        echo "Se Docker nÃ£o estiver rodando:"
        echo "- Execute: Actions â†’ Fix VPS Connectivity Issues â†’ fix-firewall"
        echo ""
        echo "Se containers nÃ£o estiverem rodando:"
        echo "- Execute: Actions â†’ Fix VPS Connectivity Issues â†’ restart-services"
        echo ""
        echo "Se precisar de reset completo:"
        echo "- Execute: Actions â†’ Fix VPS Connectivity Issues â†’ full-reset"
        echo ""
        echo "Se portas estiverem bloqueadas:"
        echo "- Verifique firewall do provedor VPS"
        echo "- Pode ser problema de security group/rede"