name: ğŸš€ Deploy UltraZend Production (Docker Only)

concurrency:
  group: ultrazend-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '31.97.162.155'
  VPS_USER: 'root'
  APP_DIR: '/var/www/ultrazend'
  APP_PORT: '3001'
  DOMAIN: 'www.ultrazend.com.br'
  NODE_VERSION: '20'

jobs:
  deploy:
    name: ğŸ¯ Deploy UltraZend System
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
      run: |
        echo "=============================================="
        echo "ğŸš€ INICIANDO DEPLOY ULTRAZEND SYSTEM"
        echo "=============================================="
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "ğŸ¯ Target: ${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "ğŸŒ Domain: ${{ env.DOMAIN }}"
        echo "=============================================="
        
        # VariÃ¡vel para tracking do tempo
        echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: ğŸ”§ Configurar SSH e Ferramentas
      run: |
        echo "ğŸ”§ Configurando SSH e ferramentas necessÃ¡rias..."
        sudo apt-get update -qq
        sudo apt-get install -y sshpass rsync curl jq
        
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "ğŸ” Testando conexÃ£o SSH..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'âœ… SSH funcionando'"; then
          echo "âœ… SSH configurado com sucesso"
        else
          echo "âŒ Falha na conexÃ£o SSH"
          exit 1
        fi

    - name: ğŸ“¥ Checkout do CÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“Š AnÃ¡lise Pre-Deploy
      run: |
        echo "ğŸ“Š Analisando estrutura do projeto..."
        echo "=================================="
        
        echo "ğŸ“ Estrutura raiz:"
        ls -la
        
        echo ""
        echo "ğŸ“ Backend:"
        if [ -d "backend" ]; then
          ls -la backend/
          if [ -f "backend/package.json" ]; then
            echo "âœ… package.json encontrado"
            echo "ğŸ“¦ DependÃªncias principais:"
            cat backend/package.json | jq -r '.dependencies | keys | .[]' | head -5
          fi
        else
          echo "âŒ DiretÃ³rio backend nÃ£o encontrado"
        fi
        
        echo ""
        echo "ğŸ“ Frontend:"
        if [ -d "frontend" ]; then
          ls -la frontend/
          if [ -f "frontend/package.json" ]; then
            echo "âœ… package.json encontrado"
            echo "ğŸ“¦ DependÃªncias principais:"
            cat frontend/package.json | jq -r '.dependencies | keys | .[]' | head -5
          fi
        else
          echo "âŒ DiretÃ³rio frontend nÃ£o encontrado"
        fi
        
        echo ""
        echo "ğŸ”§ ConfiguraÃ§Ãµes Docker:"
        ls -la configs/ docker-compose.prod.yml setup-server.sh deploy.sh 2>/dev/null || echo "âš ï¸ Arquivos de configuraÃ§Ã£o nÃ£o encontrados"

    - name: ğŸ—ï¸ Preparar Backend (sem build local)
      run: |
        echo "ğŸ—ï¸ Verificando estrutura do backend..."
        echo "======================================"
        
        if [ ! -d "backend" ]; then
          echo "âŒ DiretÃ³rio backend nÃ£o encontrado"
          exit 1
        fi
        
        cd backend
        
        echo "âœ… Backend estrutura OK - build serÃ¡ feito no servidor"
        echo "ğŸ“‹ Arquivos principais:"
        ls -la src/ | head -10
        echo "ğŸ“‹ Package.json encontrado:"
        head -10 package.json

    - name: âš›ï¸ Build Local do Frontend  
      run: |
        echo "âš›ï¸ Iniciando build local do frontend..."
        echo "======================================"
        
        if [ ! -d "frontend" ]; then
          echo "âŒ DiretÃ³rio frontend nÃ£o encontrado"
          exit 1
        fi
        
        cd frontend
        
        echo "ğŸ“¦ Instalando dependÃªncias do frontend..."
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi
        echo "âœ… DependÃªncias instaladas com sucesso"
        
        echo "ğŸ”¨ Compilando React/Vite..."
        if npm run build; then
          echo "âœ… Build do frontend concluÃ­do com sucesso"
          echo "ğŸ“Š Analisando build:"
          ls -la dist/
          echo "ğŸ“ˆ Tamanho do build: $(du -sh dist/)"
          echo "ğŸ“ Arquivos gerados: $(find dist/ -type f | wc -l)"
          
          # Verificar se arquivos essenciais foram gerados
          if [ -f "dist/index.html" ]; then
            echo "âœ… index.html encontrado"
          else
            echo "âŒ index.html nÃ£o encontrado"
            exit 1
          fi
        else
          echo "âŒ Falha no build do frontend"
          exit 1
        fi

    - name: ğŸ§¹ Preparar VPS
      run: |
        echo "ğŸ§¹ Preparando ambiente na VPS..."
        echo "================================"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'ğŸ”„ Atualizando sistema...'
        apt-get update -y > /dev/null 2>&1
        
        echo 'ğŸŸ¢ Instalando Node.js 20.x...'
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash - > /dev/null 2>&1
        apt-get install -y nodejs > /dev/null 2>&1
        
        echo 'ğŸ³ Instalando Docker...'
        curl -fsSL https://get.docker.com | sh > /dev/null 2>&1
        systemctl start docker && systemctl enable docker
        
        echo 'ğŸ³ Instalando Docker Compose...'
        curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
        
        echo 'ğŸŒ Instalando Nginx e utilitÃ¡rios...'
        apt-get install -y nginx certbot python3-certbot-nginx jq net-tools > /dev/null 2>&1
        
        echo 'ğŸ”’ Configurando firewall...'
        ufw --force enable > /dev/null 2>&1
        ufw allow ssh > /dev/null 2>&1
        ufw allow http > /dev/null 2>&1
        ufw allow https > /dev/null 2>&1
        
        echo 'âœ… VersÃµes instaladas:'
        node --version
        npm --version
        docker --version
        docker-compose --version
        nginx -v
        "

    - name: ğŸ§¹ Limpeza Completa e Backup
      run: |
        echo "ğŸ§¹ Limpeza completa do ambiente..."
        echo "=================================="
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        # Parar TUDO antes do backup - foco em Docker
        echo 'ğŸ›‘ Parando todos os serviÃ§os Docker...'
        cd ${{ env.APP_DIR }} 2>/dev/null || true
        docker-compose -f docker-compose.prod.yml down --remove-orphans --volumes 2>/dev/null || echo 'Nenhum Docker Compose rodando'
        docker stop \$(docker ps -aq) 2>/dev/null || echo 'Nenhum container rodando'
        docker rm \$(docker ps -aq) 2>/dev/null || echo 'Nenhum container para remover'
        docker system prune -f 2>/dev/null || echo 'Docker cleanup feito'
        
        # Remover PM2 completamente se ainda existir
        echo 'ğŸ—‘ï¸ Removendo PM2 (se existir)...'
        pm2 stop all 2>/dev/null || true
        pm2 delete all 2>/dev/null || true
        pm2 kill 2>/dev/null || true
        npm uninstall -g pm2 2>/dev/null || true
        
        # Criar backup se aplicaÃ§Ã£o existir
        if [ -d '${{ env.APP_DIR }}' ]; then
          echo 'ğŸ“¦ Criando backup da versÃ£o atual...'
          backup_dir='/var/backups/ultrazend/backup-\$(date +%Y%m%d-%H%M%S)'
          mkdir -p \"\$backup_dir\"
          cp -r ${{ env.APP_DIR }}/backend \"\$backup_dir/\" 2>/dev/null || true
          cp -r ${{ env.APP_DIR }}/frontend \"\$backup_dir/\" 2>/dev/null || true
          echo 'âœ… Backup criado em \$backup_dir'
          
          # LIMPEZA TOTAL - REMOVER TUDO
          echo 'ğŸ”¥ Removendo aplicaÃ§Ã£o anterior COMPLETAMENTE...'
          rm -rf ${{ env.APP_DIR }}/backend/node_modules
          rm -rf ${{ env.APP_DIR }}/frontend/node_modules
          rm -rf ${{ env.APP_DIR }}/backend/dist
          rm -rf ${{ env.APP_DIR }}/frontend/dist
          rm -rf ${{ env.APP_DIR }}/.pm2
          rm -rf ~/.pm2
          rm -f ${{ env.APP_DIR }}/backend/package-lock.json
          rm -f ${{ env.APP_DIR }}/frontend/package-lock.json
          echo 'âœ… Limpeza completa realizada'
        else
          echo 'â„¹ï¸  Primeira instalaÃ§Ã£o - sem limpeza necessÃ¡ria'
        fi
        
        # Limpar cache do sistema
        echo 'ğŸ§¹ Limpando cache do sistema...'
        npm cache clean --force 2>/dev/null || echo 'NPM cache limpo'
        apt-get autoremove -y 2>/dev/null || true
        apt-get autoclean 2>/dev/null || true
        
        echo 'ğŸ“ Recriando diretÃ³rios...'
        mkdir -p ${{ env.APP_DIR }}/{backend,frontend,data,logs,uploads,temp}
        mkdir -p ${{ env.APP_DIR }}/data/{database,cache,sessions}
        mkdir -p /var/backups/ultrazend
        echo 'âœ… Ambiente completamente limpo e preparado'
        "

    - name: ğŸ“¤ TransferÃªncia FORÃ‡ADA de CÃ³digo
      run: |
        echo "ğŸ“¤ Transferindo cÃ³digo FORÃ‡ADAMENTE para VPS..."
        echo "=============================================="
        
        echo "ğŸ“Š Analisando arquivos a transferir..."
        echo "Tamanho total: $(du -sh . | cut -f1)"
        echo "Commit atual: ${{ github.sha }}"
        
        echo "ğŸ”¥ TRANSFERÃŠNCIA FORÃ‡ADA (substituindo TUDO)..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --progress --delete --force \
          --checksum \
          --exclude='.git/' \
          --exclude='node_modules/' \
          --exclude='frontend/node_modules/' \
          --exclude='backend/node_modules/' \
          --exclude='backend/dist/' \
          --exclude='frontend/dist/' \
          --exclude='.claude/' \
          --exclude='__tests__/' \
          --exclude='coverage/' \
          --exclude='**/package-lock.json' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/; then
          echo "âœ… CÃ³digo transferido FORÃ‡ADAMENTE com sucesso"
        else
          echo "âŒ Falha na transferÃªncia forÃ§ada"
          exit 1
        fi
        
        echo "ğŸ” Verificando transferÃªncia..."
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        echo 'ğŸ“‹ Arquivos transferidos:'
        ls -la
        echo 'ğŸ“‹ Backend transferido:'
        ls -la backend/ | head -10
        echo 'ğŸ“‹ Frontend transferido:'
        ls -la frontend/ | head -10
        echo 'âœ… TransferÃªncia verificada'
        "

    - name: ğŸ”§ Configurar AplicaÃ§Ã£o no Servidor
      run: |
        echo "ğŸ”§ Configurando aplicaÃ§Ã£o no servidor..."
        echo "========================================"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        
        echo 'ğŸ“‹ Verificando estrutura transferida...'
        ls -la
        echo ''
        echo 'ğŸ“ Estrutura backend:'
        ls -la backend/
        echo ''
        echo 'ğŸ“ Estrutura configs:'
        ls -la configs/ 2>/dev/null || echo 'Configs nÃ£o encontrados'
        
        echo 'ğŸ”§ Configurando backend LIMPO...'
        cd backend
        
        # GARANTIR INSTALAÃ‡ÃƒO LIMPA
        echo 'ğŸ§¹ Removendo qualquer cache/lock restante...'
        rm -rf node_modules package-lock.json
        npm cache clean --force
        
        # Instalar TODAS as dependÃªncias (precisa dev deps para build)
        echo 'ğŸ“¦ InstalaÃ§Ã£o completa de dependÃªncias (inclui dev para build)...'
        npm install
        
        # Verificar se dependÃªncias crÃ­ticas foram instaladas
        echo 'ğŸ” Verificando dependÃªncias crÃ­ticas...'
        npm list typescript swagger-jsdoc swagger-ui-express --depth=0 || echo 'Algumas dependÃªncias podem estar faltando'
        
        # EXECUTAR BUILD NO SERVIDOR
        echo 'ğŸ—ï¸ Executando build no servidor...'
        npm run build
        
        # REMOVER DEPENDÃŠNCIAS DE DEV APÃ“S BUILD
        echo 'ğŸ§¹ Removendo dependÃªncias de dev apÃ³s build...'
        npm prune --omit=dev
        
        # Verificar build detalhadamente
        echo 'ğŸ” Verificando build...'
        if [ -d 'dist' ]; then
          echo 'âœ… DiretÃ³rio dist existe'
          ls -la dist/
          if [ -f 'dist/index.js' ]; then
            echo 'âœ… index.js encontrado'
            echo 'Tamanho: \$(du -h dist/index.js)'
          else
            echo 'âŒ index.js nÃ£o encontrado'
            echo 'ConteÃºdo de dist:'
            ls -la dist/
            exit 1
          fi
        else
          echo 'âŒ DiretÃ³rio dist nÃ£o existe'
          exit 1
        fi
        
        # Executar migraÃ§Ãµes com mais detalhes
        echo 'ğŸ—„ï¸  Executando migraÃ§Ãµes de banco...'
        if npm run migrate:latest; then
          echo 'âœ… MigraÃ§Ãµes executadas com sucesso'
        else
          echo 'âš ï¸  Falha nas migraÃ§Ãµes - continuando'
        fi
        
        cd ..
        
        # Etapa 1: Configurar Nginx HTTP temporÃ¡rio
        echo 'ğŸŒ ETAPA 1: Configurando Nginx HTTP temporÃ¡rio...'
        if [ -f 'configs/nginx-http.conf' ]; then
          echo 'Copiando configuraÃ§Ã£o HTTP temporÃ¡ria...'
          cp configs/nginx-http.conf /etc/nginx/sites-available/ultrazend-http
          ln -sf /etc/nginx/sites-available/ultrazend-http /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          
          echo 'Testando configuraÃ§Ã£o HTTP...'
          if nginx -t; then
            echo 'âœ… ConfiguraÃ§Ã£o HTTP vÃ¡lida'
            systemctl restart nginx
            systemctl enable nginx
          else
            echo 'âŒ Erro na configuraÃ§Ã£o HTTP'
            echo 'Logs do Nginx:'
            tail -20 /var/log/nginx/error.log 2>/dev/null || echo 'Sem logs de erro'
            exit 1
          fi
        else
          echo 'âŒ Arquivo nginx-http.conf nÃ£o encontrado'
          exit 1
        fi
        
        # Etapa 2: Configurar certificados SSL
        echo 'ğŸ”’ ETAPA 2: Configurando certificados SSL...'
        if [ ! -f "/etc/letsencrypt/live/${{ env.DOMAIN }}/fullchain.pem" ]; then
          echo 'Obtendo certificados SSL...'
          
          # Nginx precisa estar rodando para acme-challenge
          systemctl start nginx
          sleep 3
          
          if certbot certonly --webroot \
            -w /var/www/html \
            -d ultrazend.com.br \
            -d ${{ env.DOMAIN }} \
            --non-interactive \
            --agree-tos \
            --email admin@ultrazend.com.br; then
            echo 'âœ… Certificados SSL obtidos com sucesso'
            SSL_READY=true
          else
            echo 'âš ï¸  Falha ao obter SSL - continuando com HTTP apenas'
            SSL_READY=false
          fi
        else
          echo 'âœ… Certificados SSL jÃ¡ existem'
          SSL_READY=true
        fi
        
        # Etapa 3: Aplicar configuraÃ§Ã£o SSL se certificados estÃ£o disponÃ­veis
        echo 'ğŸ” ETAPA 3: Aplicando configuraÃ§Ã£o final...'
        if [ "$SSL_READY" = "true" ] && [ -f 'configs/nginx-ssl.conf' ]; then
          echo 'Aplicando configuraÃ§Ã£o SSL completa...'
          cp configs/nginx-ssl.conf /etc/nginx/sites-available/ultrazend
          ln -sf /etc/nginx/sites-available/ultrazend /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/ultrazend-http
          
          echo 'Testando configuraÃ§Ã£o SSL...'
          if nginx -t; then
            echo 'âœ… ConfiguraÃ§Ã£o SSL vÃ¡lida'
            systemctl reload nginx
          else
            echo 'âš ï¸  Erro na configuraÃ§Ã£o SSL - mantendo HTTP'
            ln -sf /etc/nginx/sites-available/ultrazend-http /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/ultrazend
            systemctl reload nginx
          fi
        else
          echo 'Mantendo configuraÃ§Ã£o HTTP (SSL nÃ£o disponÃ­vel)'
        fi
        
        # Definir permissÃµes com verificaÃ§Ã£o
        echo 'ğŸ” Configurando permissÃµes...'
        chown -R www-data:www-data ${{ env.APP_DIR }}
        chmod +x ${{ env.APP_DIR }}/backend/dist/index.js
        
        # Verificar se docker-compose.prod.yml existe
        if [ -f 'docker-compose.prod.yml' ]; then
          echo 'âœ… docker-compose.prod.yml encontrado'
          cat docker-compose.prod.yml | head -15
        else
          echo 'âŒ docker-compose.prod.yml nÃ£o encontrado'
          exit 1
        fi
        
        echo 'âœ… AplicaÃ§Ã£o configurada no servidor'
        "

    - name: ğŸš€ Deploy with Docker Only
      run: |
        echo "ğŸš€ Executando deploy Docker-only..."
        echo "================================="
        
        # Execute Docker deployment directly
        echo "ğŸ³ Iniciando deployment Docker..."
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        
        # Verificar estado inicial
        echo 'ğŸ“‹ Estado inicial dos serviÃ§os:'
        echo 'Docker Status:'
        docker ps || echo 'Nenhum container rodando'
        echo 'Nginx Status:'
        systemctl is-active nginx || echo 'Nginx inativo'
        
        # Iniciar Nginx com verificaÃ§Ãµes robustas
        echo 'ğŸŒ Iniciando Nginx...'
        systemctl stop nginx 2>/dev/null || true
        sleep 2
        
        if systemctl start nginx; then
          echo 'âœ… Nginx iniciado com sucesso'
          systemctl enable nginx
          
          # Verificar se estÃ¡ escutando na porta 80
          if netstat -tlnp | grep ':80 '; then
            echo 'âœ… Nginx escutando na porta 80'
          else
            echo 'âš ï¸  Nginx nÃ£o estÃ¡ escutando na porta 80'
          fi
        else
          echo 'âŒ Falha ao iniciar Nginx'
          echo 'Logs do Nginx:'
          systemctl status nginx || true
          tail -20 /var/log/nginx/error.log 2>/dev/null || echo 'Sem logs de erro do Nginx'
          exit 1
        fi
        
        # Verificar arquivos essenciais para Docker
        echo 'ğŸ” Verificando arquivos essenciais Docker...'
        if [ -f 'docker-compose.prod.yml' ]; then
          echo 'âœ… docker-compose.prod.yml presente'
          echo 'ConfiguraÃ§Ã£o Docker Compose (primeiras 20 linhas):'
          head -20 docker-compose.prod.yml
        else
          echo 'âŒ docker-compose.prod.yml nÃ£o encontrado'
          exit 1
        fi
        
        if [ -f 'backend/dist/index.js' ]; then
          echo 'âœ… backend/dist/index.js presente'
          echo 'Tamanho: $(du -sh backend/dist/index.js)'
        else
          echo 'âŒ backend/dist/index.js nÃ£o encontrado'
          echo 'ConteÃºdo do diretÃ³rio backend/dist:'
          ls -la backend/dist/ || echo 'DiretÃ³rio dist nÃ£o existe'
          exit 1
        fi
        
        # Configurar arquivos .env com fallback robusto (alinhado com correÃ§Ãµes)
        echo 'ğŸ”§ Configurando arquivos .env com estratÃ©gia de fallback...'
        
        # Tentar diferentes localizaÃ§Ãµes de .env conforme nossa correÃ§Ã£o
        ENV_CONFIGURED=false
        
        # 1. Verificar se jÃ¡ existe .env no backend
        if [ -f 'backend/.env' ]; then
          echo 'âœ… backend/.env jÃ¡ presente'
          ENV_CONFIGURED=true
        # 2. Tentar .env.production.deploy (nosso arquivo especial)
        elif [ -f 'backend/.env.production.deploy' ]; then
          echo 'ğŸ”§ Usando .env.production.deploy...'
          cp backend/.env.production.deploy backend/.env
          chmod 600 backend/.env
          chown www-data:www-data backend/.env
          ENV_CONFIGURED=true
        # 3. Tentar configs/.env.production
        elif [ -f 'configs/.env.production' ]; then
          echo 'ğŸ”§ Copiando configs/.env.production para backend/.env...'
          cp configs/.env.production backend/.env
          chmod 600 backend/.env
          chown www-data:www-data backend/.env
          ENV_CONFIGURED=true
        # 4. Tentar backend/.env.production
        elif [ -f 'backend/.env.production' ]; then
          echo 'ğŸ”§ Copiando backend/.env.production para backend/.env...'
          cp backend/.env.production backend/.env
          chmod 600 backend/.env
          chown www-data:www-data backend/.env
          ENV_CONFIGURED=true
        fi
        
        if [ "$ENV_CONFIGURED" = "false" ]; then
          echo 'âŒ Nenhum arquivo .env encontrado em locais esperados'
          echo 'ğŸ“‹ Arquivos disponÃ­veis:'
          find . -name ".env*" -type f | head -10 || echo 'Nenhum arquivo .env encontrado'
          exit 1
        fi
        
        echo 'âœ… ConfiguraÃ§Ã£o .env concluÃ­da com fallback robusto'
        
        # Iniciar aplicaÃ§Ã£o com Docker Compose
        echo 'ğŸš€ Iniciando aplicaÃ§Ã£o com Docker Compose...'
        
        # Parar containers existentes primeiro
        echo 'ğŸ›‘ Parando containers existentes...'
        docker-compose -f docker-compose.prod.yml down --remove-orphans --volumes || echo 'Nenhum container para parar'
        
        # Build e inicializaÃ§Ã£o
        echo 'ğŸ”¨ Building Docker images...'
        docker-compose -f docker-compose.prod.yml build --no-cache
        
        echo 'ğŸš€ Iniciando containers Docker...'
        if docker-compose -f docker-compose.prod.yml up -d; then
          echo 'âœ… Containers Docker iniciados'
          
          # Aguardar alguns segundos para estabilizar
          echo 'Aguardando estabilizaÃ§Ã£o (15s)...'
          sleep 15
          
          # Verificar se containers estÃ£o rodando
          echo 'ğŸ” Verificando status dos containers:'
          docker-compose -f docker-compose.prod.yml ps
          
          # Verificar se aplicaÃ§Ã£o estÃ¡ respondendo
          echo 'ğŸ¥ Teste de conectividade interna...'
          if docker-compose -f docker-compose.prod.yml exec -T ultrazend-backend curl -sf http://localhost:3001/health; then
            echo 'âœ… AplicaÃ§Ã£o respondendo internamente'
          else
            echo 'âš ï¸ AplicaÃ§Ã£o pode nÃ£o estar totalmente pronta - verificando logs...'
            docker-compose -f docker-compose.prod.yml logs --tail=20 ultrazend-backend
          fi
        else
          echo 'âŒ Falha ao iniciar containers Docker'
          echo 'Logs de erro:'
          docker-compose -f docker-compose.prod.yml logs --tail=50
          exit 1
        fi
        
        # VERIFICAÃ‡ÃƒO DE VERSÃƒO DEPLOYADA
        echo 'ğŸ” VERIFICANDO VERSÃƒO DEPLOYADA:'
        echo '================================='
        echo 'Commit deployado: ${{ github.sha }}'
        echo 'Branch: ${{ github.ref_name }}'
        echo 'Data do deploy: $(date)'
        echo ''
        
        # Status final detalhado
        echo 'ğŸ“Š STATUS FINAL DOS SERVIÃ‡OS:'
        echo '==============================='
        echo 'Docker Containers Status:'
        docker-compose -f docker-compose.prod.yml ps
        echo ''
        echo 'Docker Services Health:'
        docker-compose -f docker-compose.prod.yml exec -T ultrazend-backend curl -sf http://localhost:3001/health || echo 'Health check interno falhou'
        echo ''
        echo 'Nginx Status:'
        systemctl is-active nginx && echo 'Nginx: ATIVO' || echo 'Nginx: INATIVO'
        echo ''
        echo 'Portas em uso:'
        netstat -tlnp | grep -E ':(80|3001|443) ' || echo 'Nenhuma porta relevante encontrada'
        echo ''
        echo 'âœ… InicializaÃ§Ã£o Docker concluÃ­da com NOVA VERSÃƒO'
        "

    - name: ğŸ¥ Health Check RÃPIDO
      run: |
        echo "ğŸ¥ Health check rÃ¡pido (30s mÃ¡ximo)..."
        echo "====================================="
        
        # Aguardar sÃ³ 10s para inicializaÃ§Ã£o
        echo "â³ Aguardando 10s para inicializaÃ§Ã£o..."
        sleep 10
        
        # Health check simples e rÃ¡pido (mÃ¡ximo 3 tentativas)
        echo "ğŸ” Testando backend (3 tentativas)..."
        for i in 1 2 3; do
          echo "Tentativa $i/3..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 "http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health" 2>/dev/null || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "503" ]; then
            echo "âœ… Backend respondendo (HTTP $HTTP_CODE) - Deploy OK!"
            break
          else
            echo "âš ï¸ Backend: HTTP $HTTP_CODE"
            if [ $i -eq 3 ]; then
              echo "âš ï¸ Backend nÃ£o responde mas deploy continuarÃ¡..."
              echo "ğŸ” Status rÃ¡pido:"
              sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
              pm2 status | head -5
              echo 'Logs recentes:'
              pm2 logs ultrazend --lines 5 --nostream 2>/dev/null || echo 'Sem logs'
              "
            else
              sleep 5
            fi
          fi
        done
        
        echo "âœ… Health check concluÃ­do rapidamente!"

    - name: âœ… VerificaÃ§Ã£o Final e Resumo
      if: success()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!"
        echo "================================"
        echo "â±ï¸  Tempo total: $DURATION_FORMATTED"
        echo "ğŸŒ Website: https://${{ env.DOMAIN }}"
        echo "ğŸ¥ Health Check: https://${{ env.DOMAIN }}/health"
        echo "ğŸ”Œ API: https://${{ env.DOMAIN }}/api"
        echo "ğŸ“Š Status: ONLINE âœ…"
        echo ""
        
        # VerificaÃ§Ã£o final dos serviÃ§os Docker
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        echo 'ğŸ“Š Status final Docker:'
        docker-compose -f docker-compose.prod.yml ps
        echo ''
        echo 'ğŸ³ Container details:'
        docker ps --filter 'name=ultrazend' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
        echo ''
        echo 'ğŸŒ Status Nginx:'
        systemctl is-active nginx >/dev/null && echo 'âœ… Nginx: Active' || echo 'âŒ Nginx: Inactive'
        echo ''
        echo 'ğŸ’¾ Uso de recursos:'
        free -h | head -2
        df -h ${{ env.APP_DIR }} | tail -1
        "
        
        echo ""
        echo "ğŸŠğŸŠğŸŠ ULTRAZEND DEPLOY FINALIZADO COM SUCESSO! ğŸŠğŸŠğŸŠ"

    - name: âŒ Deploy Failed - DiagnÃ³stico
      if: failure()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "âŒ ULTRAZEND DEPLOY FALHOU!"
        echo "==========================="
        echo "â±ï¸  Tempo atÃ© falha: $DURATION_FORMATTED"
        echo "ğŸ“Š Status: FAILED âŒ"
        echo ""
        echo "ğŸ” Coletando informaÃ§Ãµes de diagnÃ³stico..."
        
        # Coletar logs detalhados Docker
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'ğŸ“‹ Status Docker:'
        docker ps 2>/dev/null || echo 'Docker nÃ£o disponÃ­vel'
        echo ''
        echo 'ğŸ“ Logs da aplicaÃ§Ã£o:'
        docker-compose -f docker-compose.prod.yml logs --tail=50 2>/dev/null || echo 'Logs Docker nÃ£o disponÃ­veis'
        echo ''
        echo 'ğŸŒ Status Nginx:'
        systemctl status nginx 2>/dev/null || echo 'Nginx nÃ£o disponÃ­vel'
        echo ''
        echo 'ğŸ’¾ Uso de disco:'
        df -h
        echo ''
        echo 'ğŸ§  Uso de memÃ³ria:'
        free -h
        " 2>/dev/null || echo "NÃ£o foi possÃ­vel conectar Ã  VPS para diagnÃ³stico"
        
        echo ""
        echo "ğŸ’¥ğŸ’¥ğŸ’¥ ULTRAZEND DEPLOY FALHOU - VERIFIQUE OS LOGS ACIMA ğŸ’¥ğŸ’¥ğŸ’¥"
        
        exit 1