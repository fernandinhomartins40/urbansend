name: Deploy Production

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "frontend/**"
      - "configs/**"
      - ".github/workflows/deploy-production.yml"
      - ".github/scripts/deploy-production-remote.sh"
  workflow_dispatch:

env:
  SERVER_HOST: root@72.60.10.108
  DOMAIN: www.ultrazend.com.br

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment:
      name: production
      url: https://www.ultrazend.com.br
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          set -eo pipefail
          install -m 700 -d "$HOME/.ssh"
          KEY_CONTENT="${{ secrets.VPS_SSH_KEY }}"
          if [ -z "$KEY_CONTENT" ]; then
            echo "ERROR: secret VPS_SSH_KEY is empty or not configured."
            exit 1
          fi
          printf '%s\n' "$KEY_CONTENT" | tr -d '\r' > "$HOME/.ssh/id_rsa"
          chmod 600 "$HOME/.ssh/id_rsa"
          ssh-keygen -y -f "$HOME/.ssh/id_rsa" > /dev/null

      - name: Test SSH connection
        shell: bash
        run: |
          set -eo pipefail
          ssh -i "$HOME/.ssh/id_rsa" \
            -o BatchMode=yes \
            -o ConnectTimeout=20 \
            -o StrictHostKeyChecking=accept-new \
            "${{ env.SERVER_HOST }}" \
            "echo SSH_OK"

      - name: Deploy via SSH
        shell: bash
        run: |
          set -eo pipefail
          ssh -i "$HOME/.ssh/id_rsa" \
            -o BatchMode=yes \
            -o ConnectTimeout=20 \
            -o StrictHostKeyChecking=accept-new \
            "${{ env.SERVER_HOST }}" \
            'bash -s' < .github/scripts/deploy-production-remote.sh

      - name: Deploy Complete
        run: |
          echo "Deploy completed"
          echo "Site: https://${{ env.DOMAIN }}"
          echo "Server: ${{ env.SERVER_HOST }}"
