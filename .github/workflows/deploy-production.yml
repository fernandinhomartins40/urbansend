name: Deploy Production

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
      - "frontend/**"
      - "configs/**"
      - ".github/workflows/deploy-production.yml"
      - ".github/scripts/deploy-production-remote.sh"
  workflow_dispatch:

env:
  SERVER_HOST: root@72.60.10.108
  DOMAIN: www.ultrazend.com.br

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment:
      name: production
      url: https://www.ultrazend.com.br
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH tools
        shell: bash
        run: |
          set -eo pipefail
          install -m 700 -d "$HOME/.ssh"
          sudo apt-get update
          sudo apt-get install -y sshpass
          ssh-keyscan -H 72.60.10.108 >> "$HOME/.ssh/known_hosts"

      - name: Test SSH connection
        shell: bash
        env:
          SSHPASS: ${{ secrets.VPS_PASSWORD }}
        run: |
          set -eo pipefail
          if [ -z "$SSHPASS" ]; then
            echo "ERROR: secret VPS_PASSWORD is empty or not configured."
            exit 1
          fi
          sshpass -e ssh \
            -o ConnectTimeout=20 \
            -o PreferredAuthentications=password \
            -o PubkeyAuthentication=no \
            -o StrictHostKeyChecking=yes \
            "${{ env.SERVER_HOST }}" \
            "echo SSH_OK"

      - name: Deploy via SSH
        shell: bash
        env:
          SSHPASS: ${{ secrets.VPS_PASSWORD }}
        run: |
          set -eo pipefail
          sshpass -e ssh \
            -o ConnectTimeout=20 \
            -o PreferredAuthentications=password \
            -o PubkeyAuthentication=no \
            -o StrictHostKeyChecking=yes \
            "${{ env.SERVER_HOST }}" \
            'bash -s' < .github/scripts/deploy-production-remote.sh

      - name: Deploy Complete
        run: |
          echo "Deploy completed"
          echo "Site: https://${{ env.DOMAIN }}"
          echo "Server: ${{ env.SERVER_HOST }}"
