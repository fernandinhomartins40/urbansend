name: üöÄ Deploy UltraZend Production (PM2 + Nginx)

concurrency:
  group: ultrazend-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force complete rebuild'
        required: false
        default: false
        type: boolean

env:
  VPS_HOST: '31.97.162.155'
  VPS_USER: 'root'
  APP_DIR: '/var/www/ultrazend'
  APP_PORT: '3001'
  DOMAIN: 'www.ultrazend.com.br'
  NODE_VERSION: '20'

jobs:
  deploy:
    name: üéØ Deploy Production (PM2 + Nginx)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: üìã Deploy Info
      run: |
        echo "üöÄ ULTRAZEND NATIVE DEPLOY"
        echo "========================="
        echo "üì¶ Commit: ${{ github.sha }}"
        echo "üåø Branch: ${{ github.ref_name }}"  
        echo "üéØ Target: ${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "üåê Domain: ${{ env.DOMAIN }}"
        echo "‚è∞ Start: $(date -u)"
        echo "========================="

    - name: üîß Setup SSH
      run: |
        sudo apt-get update -qq && sudo apt-get install -y sshpass rsync
        mkdir -p ~/.ssh && chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts
        
        # Test SSH connection
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo '‚úÖ SSH OK'"

    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json

    - name: üèóÔ∏è Build Frontend
      env:
        VITE_API_BASE_URL: https://${{ env.DOMAIN }}/api
        VITE_WS_URL: wss://${{ env.DOMAIN }}
        VITE_APP_NAME: UltraZend SMTP
        VITE_APP_VERSION: 2.0.0
        VITE_ENABLE_PWA: true
        VITE_ENABLE_NOTIFICATIONS: true
        VITE_ENABLE_DARK_MODE: true
        VITE_ENABLE_CSP: true
        VITE_SECURE_COOKIES: true
      run: |
        echo "üèóÔ∏è Building React frontend with production config..."
        cd frontend
        npm ci --silent
        echo "üìã Environment variables:"
        echo "  VITE_API_BASE_URL=$VITE_API_BASE_URL"
        echo "  VITE_WS_URL=$VITE_WS_URL"
        npm run build
        echo "‚úÖ Frontend built - Size: $(du -sh dist/)"
        ls -la dist/ | head -5

    - name: üöÄ Deploy to VPS
      run: |
        echo "üöÄ Deploying to VPS..."
        
        # Transfer code
        echo "üì§ Transferring files..."
        sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --delete \
          --exclude='.git/' --exclude='node_modules/' --exclude='.claude/' \
          --exclude='frontend/node_modules/' --exclude='backend/node_modules/' \
          --exclude='backend/dist/' --exclude='__tests__/' --exclude='coverage/' \
          --include='configs/' --include='configs/**' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/
        
        # Deploy on server
        echo "‚öôÔ∏è Configuring server..."
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        
        # Stop existing services
        echo 'üõë Stopping existing services...'
        pm2 stop ultrazend-backend 2>/dev/null || true
        pm2 delete ultrazend-backend 2>/dev/null || true
        
        # Setup backend
        echo 'üèóÔ∏è Setting up backend...'
        cd backend
        
        # Remove old build files to ensure clean build
        echo 'üóëÔ∏è Removing old build files...'
        rm -rf dist/ || true
        
        # Install Redis if not present
        echo 'üîß Ensuring Redis is available...'
        if ! command -v redis-server &> /dev/null; then
          echo 'Installing Redis...'
          apt-get update -qq && apt-get install -y redis-server
          systemctl enable redis-server
          systemctl start redis-server
        fi
        
        # Setup Email Server (Postfix) - Critical for email functionality
        echo 'üìß Ensuring Email Server (Postfix) is available...'
        if ! command -v postfix &> /dev/null; then
          echo 'Installing Postfix and mail utilities...'
          DEBIAN_FRONTEND=noninteractive apt-get install -y postfix mailutils opendkim opendkim-tools
          systemctl enable postfix
          systemctl start postfix
        fi
        
        # Configure Postfix for ultrazend.com.br with enhanced security
        echo '‚öôÔ∏è Configuring Postfix for ultrazend.com.br...'
        
        # Backup original config if it exists
        [ -f /etc/postfix/main.cf ] && cp /etc/postfix/main.cf /etc/postfix/main.cf.backup.$(date +%Y%m%d) 2>/dev/null || true
        
        # Configure main Postfix settings
        postconf -e \"myhostname=mail.ultrazend.com.br\"
        postconf -e \"mydomain=ultrazend.com.br\"
        postconf -e \"myorigin=\$mydomain\"
        postconf -e \"inet_interfaces=all\"
        postconf -e \"inet_protocols=ipv4\"
        postconf -e \"mydestination=\$myhostname, mail.ultrazend.com.br, ultrazend.com.br, localhost.localdomain, localhost\"
        postconf -e \"mynetworks=127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128\"
        postconf -e \"message_size_limit=25600000\"
        postconf -e \"mailbox_size_limit=0\"
        postconf -e \"recipient_delimiter=+\"
        
        # Security settings
        postconf -e \"smtpd_helo_restrictions=permit_mynetworks, permit_sasl_authenticated, reject_invalid_helo_hostname\"
        postconf -e \"smtpd_sender_restrictions=permit_mynetworks, permit_sasl_authenticated, reject_non_fqdn_sender\"
        postconf -e \"smtpd_recipient_restrictions=permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination\"
        
        # Rate limiting
        postconf -e \"smtpd_client_connection_count_limit=50\"
        postconf -e \"smtpd_client_connection_rate_limit=100\"
        
        # Setup OpenDKIM if not already configured
        if [ ! -d \"/etc/opendkim/keys/ultrazend.com.br\" ]; then
          echo 'üîê Setting up DKIM...'
          mkdir -p /etc/opendkim/keys/ultrazend.com.br
          chown -R opendkim:opendkim /etc/opendkim 2>/dev/null || true
          
          # Generate DKIM keys
          cd /etc/opendkim/keys/ultrazend.com.br
          opendkim-genkey -s ultrazend -d ultrazend.com.br -b 2048 2>/dev/null || true
          chown opendkim:opendkim * 2>/dev/null || true
          chmod 600 ultrazend.private 2>/dev/null || true
          
          # Basic DKIM configuration
          cat > /etc/opendkim.conf << 'DKIMEOF'
Syslog yes
SyslogSuccess yes
Canonicalization relaxed/simple
Mode sv
SubDomains yes
Socket inet:8891@localhost
PidFile /var/run/opendkim/opendkim.pid
UMask 022
UserID opendkim:opendkim
TemporaryDirectory /var/tmp
DKIMEOF

          # Configure DKIM milter in Postfix
          postconf -e \"milter_protocol=2\"
          postconf -e \"milter_default_action=accept\"
          postconf -e \"smtpd_milters=inet:localhost:8891\"
          postconf -e \"non_smtpd_milters=inet:localhost:8891\"
          
          # Start OpenDKIM
          systemctl enable opendkim 2>/dev/null || true
          systemctl start opendkim 2>/dev/null || true
        fi
        
        # Restart services to apply changes
        systemctl restart postfix
        systemctl restart opendkim 2>/dev/null || true
        
        cd ${{ env.APP_DIR }}/backend
        
        # Install all dependencies (including swagger)
        npm ci --silent
        npm install swagger-jsdoc swagger-ui-express --save --silent
        
        # Build the application
        npm run build
        
        # Copy and configure environment
        if [ -f ../configs/.env.production ]; then
          cp ../configs/.env.production .env
          chmod 600 .env
          echo 'Production .env configured'
        else
          echo 'Creating minimal .env...'
          echo 'NODE_ENV=production' > .env
          echo 'PORT=3001' >> .env
          echo 'HOST=0.0.0.0' >> .env
          echo 'DATABASE_URL=/var/www/ultrazend/backend/ultrazend.sqlite' >> .env
          echo 'REDIS_URL=redis://127.0.0.1:6379' >> .env
          echo 'LOG_FILE_PATH=/var/www/ultrazend/logs' >> .env
          echo 'LOG_LEVEL=info' >> .env
          chmod 600 .env
        fi
        
        # Configure email server settings - ARQUITETURA DUAL ALINHADA
        echo 'üìß Configuring DUAL email server architecture...'
        echo '  üè¢ Postfix (External MX): Port 25'  
        echo '  üîß UltraZend SMTPServer: Port 2525 (MX) + 587 (Submission)'
        
        # Verify dual architecture configuration (don't overwrite .env.production)
        if grep -q 'SMTP_MX_PORT=2525' .env; then
          echo '‚úÖ Dual SMTP architecture configuration found in .env'
        else
          echo '‚ö†Ô∏è  Adding dual architecture configuration to .env...'
          echo 'SMTP_MX_PORT=2525' >> .env
          echo 'SMTP_SUBMISSION_PORT=587' >> .env
        fi
        
        # Only ensure basic email settings (don't override dual config)
        grep -q '^MAIL_FROM_EMAIL=' .env || echo 'MAIL_FROM_EMAIL=noreply@ultrazend.com.br' >> .env
        grep -q '^MAIL_FROM_NAME=' .env || echo 'MAIL_FROM_NAME=ULTRAZEND' >> .env
        
        echo '‚úÖ Dual email architecture validated'
        
        # Ensure log directories exist
        mkdir -p /var/www/ultrazend/logs/{application,errors,security,performance,business}
        chown -R www-data:www-data /var/www/ultrazend/logs || true
        
        # Run migrations with better error handling
        echo 'Running database migrations...'
        npm run migrate:latest || echo 'Migration completed with warnings - continuing...'
        
        cd ..
        
        # Setup frontend in nginx
        echo 'üåê Setting up frontend...'
        echo 'üóëÔ∏è Removing old frontend files...'
        rm -rf /var/www/ultrazend-static
        mkdir -p /var/www/ultrazend-static
        echo 'üìÅ Copying new frontend build...'
        cp -r frontend/dist/* /var/www/ultrazend-static/
        chown -R www-data:www-data /var/www/ultrazend-static
        echo '‚úÖ Frontend deployed - Size: $(du -sh /var/www/ultrazend-static/)'
        
        # Configure nginx with SSL automatically
        echo 'üîí Configuring Nginx with SSL...'
        if [ -f scripts/setup-nginx-ssl.sh ]; then
          chmod +x scripts/setup-nginx-ssl.sh
          ./scripts/setup-nginx-ssl.sh
        else
          echo '‚ö†Ô∏è SSL setup script not found, using manual configuration...'
          # Fallback: usar configura√ß√£o SSL se existir certificado
          if [ -f /etc/letsencrypt/live/www.ultrazend.com.br/fullchain.pem ]; then
            echo 'Using SSL configuration'
            cp configs/nginx-ssl.conf /etc/nginx/sites-available/ultrazend
          else
            echo 'Using HTTP configuration and obtaining SSL certificate'
            cp configs/nginx-http.conf /etc/nginx/sites-available/ultrazend
            sed -i 's|/var/www/ultrazend/frontend/dist|/var/www/ultrazend-static|g' /etc/nginx/sites-available/ultrazend
          fi
          
          ln -sf /etc/nginx/sites-available/ultrazend /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          nginx -t && systemctl reload nginx
          
          # Tentar obter SSL se n√£o existir
          if [ ! -f /etc/letsencrypt/live/www.ultrazend.com.br/fullchain.pem ]; then
            echo 'Obtaining SSL certificate...'
            certbot --nginx -d www.ultrazend.com.br --non-interactive --agree-tos --email admin@ultrazend.com.br || echo 'SSL setup completed with warnings'
            systemctl reload nginx
          fi
        fi
        
        # Start backend with PM2 using ecosystem config
        echo 'üöÄ Starting backend with PM2...'
        pm2 start ecosystem.config.js --env production
        pm2 save
        
        echo '‚úÖ Native deploy completed!'
        echo ''
        echo 'Services Status:'
        pm2 status
        echo ''
        echo 'Nginx Status:'
        systemctl is-active nginx && echo 'Nginx: Active' || echo 'Nginx: Inactive'
        "

    - name: üè• Health Check
      run: |
        echo "üè• Testing deployed application..."
        sleep 15
        
        # Test backend directly
        for i in 1 2 3; do
          if curl -f --connect-timeout 10 "http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health"; then
            echo "‚úÖ Backend healthy!"
            break
          else
            echo "‚ö†Ô∏è Backend attempt $i failed, retrying..."
            sleep 5
          fi
        done
        
        # Test frontend via HTTPS (with fallback to HTTP)
        echo "üåê Testing frontend access..."
        if curl -f --connect-timeout 10 "https://${{ env.DOMAIN }}/"; then
          echo "‚úÖ HTTPS Frontend working!"
        elif curl -f --connect-timeout 10 "http://${{ env.VPS_HOST }}/"; then
          echo "‚úÖ HTTP Frontend working!"
        else
          echo "‚ö†Ô∏è Frontend may not be ready"
        fi
        
        # Test API via HTTPS (with fallback to HTTP)
        echo "üîå Testing API access..."
        if curl -f --connect-timeout 10 "https://${{ env.DOMAIN }}/api/health"; then
          echo "‚úÖ HTTPS API working!"
        elif curl -f --connect-timeout 10 "http://${{ env.VPS_HOST }}/api/health"; then
          echo "‚úÖ HTTP API working!"
        else
          echo "‚ö†Ô∏è API may not be ready"
        fi

    - name: ‚úÖ Deploy Complete
      run: |
        echo "üéâ ULTRAZEND DEPLOY COMPLETE!"
        echo "============================"
        echo "üîí Website: https://${{ env.DOMAIN }}"
        echo "üè• Health: https://${{ env.DOMAIN }}/api/health"
        echo "üîå API: https://${{ env.DOMAIN }}/api"
        echo "üìö Docs: https://${{ env.DOMAIN }}/api-docs"
        echo ""
        echo "‚ú® Deployed with PM2 + Nginx + SSL (Auto-configured!)"
        echo "‚è∞ Deploy completed at: $(date -u)"