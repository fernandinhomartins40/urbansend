# ğŸš€ ULTRAZEND DEPLOY PRODUCTION - BASEADO NO LOCAL-DEPLOY.SH QUE FUNCIONA
# VersÃ£o simplificada que replica exatamente o local-deploy.sh

name: ğŸš€ Deploy Production

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'configs/**'
  workflow_dispatch:

env:
  SERVER_HOST: root@ultrazend.com.br
  APP_DIR: /var/www/ultrazend
  STATIC_DIR: /var/www/ultrazend-static
  DOMAIN: www.ultrazend.com.br

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: https://www.ultrazend.com.br
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ultrazend.com.br >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy via SSH (Replicando local-deploy.sh)
        run: |
          ssh ${{ env.SERVER_HOST }} << 'DEPLOY_SCRIPT'
          set -e
          
          echo "ğŸš€ ULTRAZEND DEPLOY VIA GITHUB ACTIONS - INICIANDO..."
          echo "=================================================="
          
          # Configuration
          APP_DIR="/var/www/ultrazend"
          STATIC_DIR="/var/www/ultrazend-static"
          DOMAIN="www.ultrazend.com.br"
          
          # 1. STOP EXISTING SERVICES
          echo "ğŸ›‘ Parando serviÃ§os existentes..."
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          
          # 2. SETUP DIRECTORIES AND CLONE
          echo "ğŸ“ Configurando diretÃ³rios..."
          mkdir -p $APP_DIR $STATIC_DIR $APP_DIR/logs/{application,errors,security,performance,business}
          rm -rf $APP_DIR
          git clone https://github.com/fernandinhomartins40/urbansend.git $APP_DIR
          cd $APP_DIR
          echo 'âœ… RepositÃ³rio clonado'
          
          # 3. BUILD FRONTEND
          echo "ğŸ—ï¸ Compilando frontend..."
          cd $APP_DIR/frontend
          npm ci --silent --no-progress
          npm run build
          
          # Copy to static directory
          rm -rf $STATIC_DIR/*
          cp -r dist/* $STATIC_DIR/
          chown -R www-data:www-data $STATIC_DIR
          echo 'âœ… Frontend compilado e copiado'
          
          # 4. BUILD BACKEND
          echo "ğŸ”¨ Compilando backend..."
          cd $APP_DIR/backend
          npm ci --silent --no-progress
          npm run build
          
          # Validate build
          if [ ! -f './dist/config/database.js' ]; then
            echo 'âŒ Database config nÃ£o encontrado apÃ³s build'
            ls -la ./dist/config/ || echo 'dist/config nÃ£o existe'
            exit 1
          fi
          echo 'âœ… Backend compilado com sucesso'
          
          # 5. SETUP ENVIRONMENT
          echo "âš™ï¸ Configurando environment..."
          cd $APP_DIR/backend
          cat > .env << 'ENV_EOF'
NODE_ENV=production
PORT=3001
DATABASE_URL=/var/www/ultrazend/backend/ultrazend.sqlite
LOG_FILE_PATH=/var/www/ultrazend/logs
SMTP_HOST=localhost
SMTP_PORT=25
ULTRAZEND_DIRECT_DELIVERY=true
ENABLE_DKIM=true
DKIM_PRIVATE_KEY_PATH=/var/www/ultrazend/configs/dkim-keys/ultrazend.com.br-default-private.pem
DKIM_SELECTOR=default
DKIM_DOMAIN=ultrazend.com.br
QUEUE_ENABLED=true
ENV_EOF
          chmod 600 .env
          echo 'Environment configurado'
          
          # Fix DKIM permissions
          echo 'Corrigindo permissoes DKIM...'
          chown -R root:root /var/www/ultrazend/configs/dkim-keys/ || true
          chmod -R 644 /var/www/ultrazend/configs/dkim-keys/ || true
          
          # Validate DKIM file exists
          if [ -f '/var/www/ultrazend/configs/dkim-keys/ultrazend.com.br-default-private.pem' ]; then
            echo 'DKIM private key found'
          else
            echo 'âŒ CRÃTICO: DKIM private key not found - Deploy may fail'
            ls -la /var/www/ultrazend/configs/dkim-keys/ || echo 'DKIM directory not found'
          fi
          
          # 6. RUN MIGRATIONS
          echo "ğŸ“Š Executando migrations..."
          cd $APP_DIR/backend
          export NODE_ENV=production
          npm run migrate:latest
          
          migration_count=$(NODE_ENV=production npx knex migrate:list 2>/dev/null | grep -c "Batch\\|COMPLETED\\|âœ”" || echo "0")
          echo "Migrations aplicadas: $migration_count"
          if [ "$migration_count" -lt 5 ]; then
            echo 'âŒ CRÃTICO: Poucas migrations aplicadas - Deploy CANCELADO'
            exit 1
          fi
          echo 'âœ… Migrations executadas com sucesso'
          
          # 7. CONFIGURE NGINX
          echo "ğŸŒ Configurando Nginx..."
          cat > /etc/nginx/sites-available/ultrazend << 'NGINX_EOF'
server {
    listen 80;
    server_name www.ultrazend.com.br;
    
    # Frontend static files
    location / {
        root /var/www/ultrazend-static;
        try_files $uri $uri/ /index.html;
        
        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API Backend
    location /api/ {
        proxy_pass http://127.0.0.1:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}
NGINX_EOF
          
          # Enable site
          ln -sf /etc/nginx/sites-available/ultrazend /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          nginx -t && echo 'âœ… Nginx configurado com sucesso'
          
          # 8. SETUP PM2 ECOSYSTEM
          echo "ğŸš€ Configurando PM2..."
          cd $APP_DIR/backend
          cat > ecosystem.config.js << 'PM2_EOF'
module.exports = {
  apps: [{
    name: 'ultrazend-api',
    script: './dist/index.js',
    instances: 1,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    log_file: '/var/www/ultrazend/logs/application/combined.log',
    out_file: '/var/www/ultrazend/logs/application/out.log',
    error_file: '/var/www/ultrazend/logs/errors/error.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_restarts: 10,
    min_uptime: '10s',
    max_memory_restart: '512M'
  }]
};
PM2_EOF
          echo 'âœ… PM2 ecosystem configurado'
          
          # 9. START SERVICES
          echo "ğŸš€ Iniciando serviÃ§os..."
          # Install PM2 globally if not exists
          npm list -g pm2 >/dev/null 2>&1 || npm install -g pm2
          
          cd $APP_DIR/backend
          pm2 start ecosystem.config.js --env production
          pm2 save
          
          # Reload nginx
          systemctl reload nginx
          echo 'âœ… ServiÃ§os iniciados'
          
          # 10. SETUP SSL (if not exists)
          echo "ğŸ”’ Configurando SSL..."
          if [ ! -f /etc/letsencrypt/live/$DOMAIN/fullchain.pem ]; then
            echo 'Obtendo certificado SSL...'
            certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email admin@ultrazend.com.br || echo 'SSL setup completed with warnings'
            systemctl reload nginx
          else
            echo 'SSL jÃ¡ configurado'
          fi
          
          # 11. VALIDATE DEPLOYMENT
          echo "ğŸ” Validando deployment..."
          sleep 5
          
          # Check PM2
          if pm2 show ultrazend-api >/dev/null 2>&1; then
            echo 'âœ… PM2: ultrazend-api rodando'
          else
            echo 'âŒ PM2: ultrazend-api falhou'
            pm2 logs ultrazend-api --lines 10 || true
          fi
          
          # Check Nginx
          if nginx -t >/dev/null 2>&1; then
            echo 'âœ… Nginx: configuraÃ§Ã£o OK'
          else
            echo 'âŒ Nginx: erro na configuraÃ§Ã£o'
          fi
          
          # Test database
          cd $APP_DIR/backend
          export NODE_ENV=production
          echo 'const db = require("./dist/config/database.js").default; db.raw("SELECT 1").then(() => { console.log("DB_OK"); process.exit(0); }).catch(err => { console.error("DB_ERROR:", err.message); process.exit(1); });' > /tmp/db_test.js
          if timeout 10s NODE_ENV=production node /tmp/db_test.js 2>/dev/null | grep -q 'DB_OK'; then
            echo 'âœ… Database: conectividade OK'
          else
            echo 'âŒ CRÃTICO: Database erro de conectividade - DEPLOY FALHOU'
            echo 'Debug output:'
            NODE_ENV=production node /tmp/db_test.js || true
            rm -f /tmp/db_test.js
            exit 1
          fi
          rm -f /tmp/db_test.js
          
          # Final status
          echo ''
          echo 'ğŸ‰ DEPLOY CONCLUÃDO!'
          echo '==================='
          echo 'Frontend: $STATIC_DIR'
          echo 'Backend: $APP_DIR/backend'
          echo 'API URL: http://$DOMAIN/api/'
          echo 'Frontend URL: http://$DOMAIN/'
          
          pm2_status=$(pm2 list | grep ultrazend-api | awk '{print $10}' || echo 'not found')
          echo "PM2 Status: $pm2_status"
          
DEPLOY_SCRIPT

      - name: âœ… Deploy Complete
        run: |
          echo "ğŸ‰ DEPLOY GITHUB ACTIONS CONCLUÃDO!"
          echo "================================="
          echo "ğŸŒ Site: https://${{ env.DOMAIN }}"
          echo "ğŸ“Š Monitorar: ssh ${{ env.SERVER_HOST }} 'pm2 list'"
          echo "ğŸ”„ PrÃ³ximo deploy: Push to main branch"