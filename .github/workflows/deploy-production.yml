name: ğŸš€ Deploy UltraZend Production System

concurrency:
  group: ultrazend-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '31.97.162.155'
  VPS_USER: 'root'
  APP_DIR: '/var/www/ultrazend'
  APP_PORT: '3001'
  DOMAIN: 'www.ultrazend.com.br'
  NODE_VERSION: '20'

jobs:
  deploy:
    name: ğŸ¯ Deploy UltraZend System
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
      run: |
        echo "=============================================="
        echo "ğŸš€ INICIANDO DEPLOY ULTRAZEND SYSTEM"
        echo "=============================================="
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "ğŸ¯ Target: ${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "ğŸŒ Domain: ${{ env.DOMAIN }}"
        echo "=============================================="
        
        # VariÃ¡vel para tracking do tempo
        echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: ğŸ”§ Configurar SSH e Ferramentas
      run: |
        echo "ğŸ”§ Configurando SSH e ferramentas necessÃ¡rias..."
        sudo apt-get update -qq
        sudo apt-get install -y sshpass rsync curl jq
        
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "ğŸ” Testando conexÃ£o SSH..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'âœ… SSH funcionando'"; then
          echo "âœ… SSH configurado com sucesso"
        else
          echo "âŒ Falha na conexÃ£o SSH"
          exit 1
        fi

    - name: ğŸ“¥ Checkout do CÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“Š AnÃ¡lise Pre-Deploy
      run: |
        echo "ğŸ“Š Analisando estrutura do projeto..."
        echo "=================================="
        
        echo "ğŸ“ Estrutura raiz:"
        ls -la
        
        echo ""
        echo "ğŸ“ Backend:"
        if [ -d "backend" ]; then
          ls -la backend/
          if [ -f "backend/package.json" ]; then
            echo "âœ… package.json encontrado"
            echo "ğŸ“¦ DependÃªncias principais:"
            cat backend/package.json | jq -r '.dependencies | keys | .[]' | head -5
          fi
        else
          echo "âŒ DiretÃ³rio backend nÃ£o encontrado"
        fi
        
        echo ""
        echo "ğŸ“ Frontend:"
        if [ -d "frontend" ]; then
          ls -la frontend/
          if [ -f "frontend/package.json" ]; then
            echo "âœ… package.json encontrado"
            echo "ğŸ“¦ DependÃªncias principais:"
            cat frontend/package.json | jq -r '.dependencies | keys | .[]' | head -5
          fi
        else
          echo "âŒ DiretÃ³rio frontend nÃ£o encontrado"
        fi
        
        echo ""
        echo "ğŸ”§ ConfiguraÃ§Ãµes:"
        ls -la configs/ ecosystem.config.js 2>/dev/null || echo "âš ï¸ Arquivos de configuraÃ§Ã£o nÃ£o encontrados"

    - name: ğŸ—ï¸ Build Local do Backend
      run: |
        echo "ğŸ—ï¸ Iniciando build local do backend..."
        echo "======================================"
        
        if [ ! -d "backend" ]; then
          echo "âŒ DiretÃ³rio backend nÃ£o encontrado"
          exit 1
        fi
        
        cd backend
        
        echo "ğŸ“¦ Instalando dependÃªncias do backend..."
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi
        echo "âœ… DependÃªncias instaladas com sucesso"
        
        echo "ğŸ”¨ Compilando TypeScript..."
        if npm run build; then
          echo "âœ… Build do backend concluÃ­do com sucesso"
          echo "ğŸ“Š Analisando build:"
          ls -la dist/
          echo "ğŸ“ˆ Tamanho do build: $(du -sh dist/)"
          echo "ğŸ“ Arquivos gerados: $(find dist/ -type f | wc -l)"
          
          # Verificar arquivo principal
          if [ -f "dist/index.js" ]; then
            echo "âœ… index.js encontrado"
          else
            echo "âŒ index.js nÃ£o encontrado"
            exit 1
          fi
        else
          echo "âŒ Falha no build do backend"
          exit 1
        fi

    - name: âš›ï¸ Build Local do Frontend  
      run: |
        echo "âš›ï¸ Iniciando build local do frontend..."
        echo "======================================"
        
        if [ ! -d "frontend" ]; then
          echo "âŒ DiretÃ³rio frontend nÃ£o encontrado"
          exit 1
        fi
        
        cd frontend
        
        echo "ğŸ“¦ Instalando dependÃªncias do frontend..."
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi
        echo "âœ… DependÃªncias instaladas com sucesso"
        
        echo "ğŸ”¨ Compilando React/Vite..."
        if npm run build; then
          echo "âœ… Build do frontend concluÃ­do com sucesso"
          echo "ğŸ“Š Analisando build:"
          ls -la dist/
          echo "ğŸ“ˆ Tamanho do build: $(du -sh dist/)"
          echo "ğŸ“ Arquivos gerados: $(find dist/ -type f | wc -l)"
          
          # Verificar se arquivos essenciais foram gerados
          if [ -f "dist/index.html" ]; then
            echo "âœ… index.html encontrado"
          else
            echo "âŒ index.html nÃ£o encontrado"
            exit 1
          fi
        else
          echo "âŒ Falha no build do frontend"
          exit 1
        fi

    - name: ğŸ§¹ Preparar VPS
      run: |
        echo "ğŸ§¹ Preparando ambiente na VPS..."
        echo "================================"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'ğŸ”„ Atualizando sistema...'
        apt-get update -y > /dev/null 2>&1
        
        echo 'ğŸŸ¢ Instalando Node.js 20.x...'
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash - > /dev/null 2>&1
        apt-get install -y nodejs > /dev/null 2>&1
        
        echo 'ğŸ“¦ Instalando PM2...'
        npm install -g pm2 > /dev/null 2>&1
        
        echo 'ğŸŒ Instalando Nginx...'
        apt-get install -y nginx certbot python3-certbot-nginx > /dev/null 2>&1
        
        echo 'ğŸ”’ Configurando firewall...'
        ufw --force enable > /dev/null 2>&1
        ufw allow ssh > /dev/null 2>&1
        ufw allow http > /dev/null 2>&1
        ufw allow https > /dev/null 2>&1
        
        echo 'âœ… VersÃµes instaladas:'
        node --version
        npm --version
        pm2 --version
        nginx -v
        "

    - name: ğŸ§¹ Backup e Limpeza
      run: |
        echo "ğŸ§¹ Backup da versÃ£o atual e limpeza..."
        echo "======================================"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        # Criar backup se aplicaÃ§Ã£o existir
        if [ -d '${{ env.APP_DIR }}' ]; then
          echo 'ğŸ“¦ Criando backup da versÃ£o atual...'
          backup_dir='/var/backups/ultrazend/backup-\$(date +%Y%m%d-%H%M%S)'
          mkdir -p \"\$backup_dir\"
          cp -r ${{ env.APP_DIR }}/backend \"\$backup_dir/\" 2>/dev/null || true
          cp -r ${{ env.APP_DIR }}/frontend \"\$backup_dir/\" 2>/dev/null || true
          echo 'âœ… Backup criado em \$backup_dir'
        else
          echo 'â„¹ï¸  Primeira instalaÃ§Ã£o - sem backup necessÃ¡rio'
        fi
        
        echo 'ğŸ›‘ Parando aplicaÃ§Ã£o existente...'
        pm2 stop ultrazend 2>/dev/null && echo 'âœ… PM2 parado' || echo 'â„¹ï¸  Nenhuma aplicaÃ§Ã£o PM2 rodando'
        pm2 delete ultrazend 2>/dev/null && echo 'âœ… PM2 removido' || echo 'â„¹ï¸  Nenhuma aplicaÃ§Ã£o PM2 para remover'
        
        echo 'ğŸ“ Preparando diretÃ³rio...'
        mkdir -p ${{ env.APP_DIR }}/{backend,frontend,data,logs,uploads,temp}
        mkdir -p ${{ env.APP_DIR }}/data/{database,cache,sessions}
        mkdir -p /var/backups/ultrazend
        echo 'âœ… DiretÃ³rios preparados'
        "

    - name: ğŸ“¤ Transferir CÃ³digo para VPS
      run: |
        echo "ğŸ“¤ Transferindo cÃ³digo para VPS..."
        echo "=================================="
        
        echo "ğŸ“Š Analisando arquivos a transferir..."
        echo "Tamanho total: $(du -sh . | cut -f1)"
        
        echo "ğŸš€ Iniciando transferÃªncia..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --progress --delete \
          --exclude='.git/' \
          --exclude='node_modules/' \
          --exclude='frontend/node_modules/' \
          --exclude='backend/node_modules/' \
          --exclude='.claude/' \
          --exclude='__tests__/' \
          --exclude='coverage/' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/; then
          echo "âœ… CÃ³digo transferido com sucesso"
        else
          echo "âŒ Falha na transferÃªncia"
          exit 1
        fi

    - name: ğŸ”§ Configurar AplicaÃ§Ã£o no Servidor
      run: |
        echo "ğŸ”§ Configurando aplicaÃ§Ã£o no servidor..."
        echo "========================================"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        
        echo 'ğŸ“‹ Verificando estrutura transferida...'
        ls -la
        
        echo 'ğŸ”§ Configurando backend...'
        cd backend
        
        # Instalar dependÃªncias de produÃ§Ã£o
        echo 'ğŸ“¦ Instalando dependÃªncias de produÃ§Ã£o...'
        if [ -f 'package-lock.json' ]; then
          npm ci --only=production
        else
          npm install --only=production
        fi
        
        # Verificar build
        if [ ! -f 'dist/index.js' ]; then
          echo 'âŒ Build nÃ£o encontrado no servidor'
          exit 1
        fi
        echo 'âœ… Build verificado'
        
        # Executar migraÃ§Ãµes
        echo 'ğŸ—„ï¸  Executando migraÃ§Ãµes de banco...'
        npm run migrate:latest || echo 'Migrations completed or not needed'
        
        cd ..
        
        # Configurar Nginx
        if [ -f 'configs/nginx-ssl.conf' ]; then
          echo 'ğŸŒ Configurando Nginx...'
          cp configs/nginx-ssl.conf /etc/nginx/sites-available/ultrazend
          ln -sf /etc/nginx/sites-available/ultrazend /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          
          # Testar configuraÃ§Ã£o
          if nginx -t; then
            echo 'âœ… ConfiguraÃ§Ã£o Nginx vÃ¡lida'
          else
            echo 'âŒ Erro na configuraÃ§Ã£o Nginx'
            exit 1
          fi
        fi
        
        # Configurar SSL se ainda nÃ£o existir
        if [ ! -f '/etc/letsencrypt/live/${{ env.DOMAIN }}/fullchain.pem' ]; then
          echo 'ğŸ”’ Configurando certificados SSL...'
          systemctl stop nginx 2>/dev/null || true
          certbot certonly --standalone \
            -d ultrazend.com.br \
            -d ${{ env.DOMAIN }} \
            --non-interactive \
            --agree-tos \
            --email admin@ultrazend.com.br \
            || echo 'âš ï¸  SSL certificate generation failed - continuing without SSL'
        fi
        
        # Definir permissÃµes
        chown -R www-data:www-data ${{ env.APP_DIR }}
        chmod +x ${{ env.APP_DIR }}/backend/dist/index.js
        
        echo 'âœ… AplicaÃ§Ã£o configurada no servidor'
        "

    - name: ğŸš€ Iniciar AplicaÃ§Ã£o
      run: |
        echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
        echo "========================="
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        
        # Iniciar Nginx
        systemctl start nginx
        systemctl enable nginx
        echo 'âœ… Nginx iniciado'
        
        # Iniciar aplicaÃ§Ã£o com PM2
        echo 'ğŸš€ Iniciando aplicaÃ§Ã£o com PM2...'
        if pm2 start ecosystem.config.js --env production; then
          echo 'âœ… AplicaÃ§Ã£o iniciada com PM2'
        else
          echo 'âŒ Falha ao iniciar aplicaÃ§Ã£o'
          exit 1
        fi
        
        # Salvar configuraÃ§Ã£o PM2
        pm2 save
        
        # Configurar inicializaÃ§Ã£o automÃ¡tica
        pm2 startup systemd -u root --hp /root | grep '^sudo' | bash || echo 'PM2 startup may already be configured'
        
        echo 'ğŸ“Š Status da aplicaÃ§Ã£o:'
        pm2 status
        "

    - name: ğŸ¥ Health Checks Inteligentes
      run: |
        echo "ğŸ¥ Executando health checks inteligentes..."
        echo "=========================================="
        
        # FunÃ§Ã£o para health check com retry
        health_check() {
          local url=$1
          local name=$2
          local max_attempts=20
          local delay=15
          
          echo "ğŸ” Verificando $name..."
          
          for attempt in $(seq 1 $max_attempts); do
            local total_wait=$((attempt * delay))
            echo "â³ Tentativa $attempt/$max_attempts (${total_wait}s total) - $name"
            
            local response=$(curl -s -o /dev/null -w "%{http_code}|%{time_total}" "$url" 2>/dev/null || echo "000|0")
            local http_code=$(echo $response | cut -d'|' -f1)
            local time_total=$(echo $response | cut -d'|' -f2)
            
            case $http_code in
              200)
                echo "âœ… $name: Respondendo corretamente (${time_total}s)"
                return 0
                ;;
              000)
                echo "â³ $name: ServiÃ§o ainda nÃ£o responde..."
                ;;
              *)
                echo "âš ï¸  $name: HTTP $http_code (aguardando...)"
                ;;
            esac
            
            if [ $attempt -lt $max_attempts ]; then
              sleep $delay
            fi
          done
          
          echo "âŒ $name: Falhou apÃ³s ${max_attempts} tentativas (${total_wait}s total)"
          return 1
        }
        
        echo ""
        echo "ğŸ¥ Aguardando inicializaÃ§Ã£o completa (60s)..."
        sleep 60
        
        # Health check do backend local
        if health_check "http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health" "Backend Local"; then
          echo "âœ… Backend local estÃ¡ funcionando!"
        else
          echo "âŒ Backend local nÃ£o estÃ¡ respondendo"
          BACKEND_FAILED=1
        fi
        
        echo ""
        
        # Health check do frontend via HTTPS
        if health_check "https://${{ env.DOMAIN }}/health" "Frontend HTTPS"; then
          echo "âœ… Frontend HTTPS estÃ¡ funcionando!"
        else
          echo "âš ï¸ Frontend HTTPS nÃ£o responde - testando HTTP..."
          if health_check "http://${{ env.DOMAIN }}" "Frontend HTTP"; then
            echo "âœ… Frontend HTTP estÃ¡ funcionando!"
          else
            echo "âŒ Frontend nÃ£o estÃ¡ respondendo"
            FRONTEND_FAILED=1
          fi
        fi
        
        # Verificar logs se houver falha
        if [ "${BACKEND_FAILED}" = "1" ] || [ "${FRONTEND_FAILED}" = "1" ]; then
          echo ""
          echo "ğŸ” Coletando logs para diagnÃ³stico..."
          echo "===================================="
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.APP_DIR }}
          echo 'ğŸ“‹ Status PM2:'
          pm2 status
          echo ''
          echo 'ğŸ“ Logs recentes (Ãºltimas 50 linhas):'
          pm2 logs ultrazend --lines 50 --nostream
          echo ''
          echo 'ğŸ“‹ Status Nginx:'
          systemctl status nginx
          "
          
          exit 1
        fi

    - name: âœ… VerificaÃ§Ã£o Final e Resumo
      if: success()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!"
        echo "================================"
        echo "â±ï¸  Tempo total: $DURATION_FORMATTED"
        echo "ğŸŒ Website: https://${{ env.DOMAIN }}"
        echo "ğŸ¥ Health Check: https://${{ env.DOMAIN }}/health"
        echo "ğŸ”Œ API: https://${{ env.DOMAIN }}/api"
        echo "ğŸ“Š Status: ONLINE âœ…"
        echo ""
        
        # VerificaÃ§Ã£o final dos serviÃ§os
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        echo 'ğŸ“Š Status final PM2:'
        pm2 jlist | jq -r '.[] | select(.name==\"ultrazend\") | \"Status: \" + .pm2_env.status + \" | PID: \" + (.pid|tostring) + \" | Uptime: \" + .pm2_env.pm_uptime'
        echo ''
        echo 'ğŸŒ Status Nginx:'
        systemctl is-active nginx >/dev/null && echo 'âœ… Nginx: Active' || echo 'âŒ Nginx: Inactive'
        echo ''
        echo 'ğŸ’¾ Uso de recursos:'
        free -h | head -2
        df -h ${{ env.APP_DIR }} | tail -1
        "
        
        echo ""
        echo "ğŸŠğŸŠğŸŠ ULTRAZEND DEPLOY FINALIZADO COM SUCESSO! ğŸŠğŸŠğŸŠ"

    - name: âŒ Deploy Failed - DiagnÃ³stico
      if: failure()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "âŒ ULTRAZEND DEPLOY FALHOU!"
        echo "==========================="
        echo "â±ï¸  Tempo atÃ© falha: $DURATION_FORMATTED"
        echo "ğŸ“Š Status: FAILED âŒ"
        echo ""
        echo "ğŸ” Coletando informaÃ§Ãµes de diagnÃ³stico..."
        
        # Coletar logs detalhados
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'ğŸ“‹ Status PM2:'
        pm2 status 2>/dev/null || echo 'PM2 nÃ£o disponÃ­vel'
        echo ''
        echo 'ğŸ“ Logs da aplicaÃ§Ã£o:'
        pm2 logs ultrazend --lines 50 --nostream 2>/dev/null || echo 'Logs PM2 nÃ£o disponÃ­veis'
        echo ''
        echo 'ğŸŒ Status Nginx:'
        systemctl status nginx 2>/dev/null || echo 'Nginx nÃ£o disponÃ­vel'
        echo ''
        echo 'ğŸ’¾ Uso de disco:'
        df -h
        echo ''
        echo 'ğŸ§  Uso de memÃ³ria:'
        free -h
        " 2>/dev/null || echo "NÃ£o foi possÃ­vel conectar Ã  VPS para diagnÃ³stico"
        
        echo ""
        echo "ğŸ’¥ğŸ’¥ğŸ’¥ ULTRAZEND DEPLOY FALHOU - VERIFIQUE OS LOGS ACIMA ğŸ’¥ğŸ’¥ğŸ’¥"
        
        exit 1