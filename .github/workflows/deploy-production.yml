# ULTRAZEND DEPLOY PRODUCTION - BASEADO NO LOCAL-DEPLOY.SH QUE FUNCIONA
# Versao simplificada que replica exatamente o local-deploy.sh

name: Deploy Production

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'configs/**'
  workflow_dispatch:

env:
  SERVER_HOST: root@72.60.10.108
  APP_DIR: /var/www/ultrazend
  STATIC_DIR: /var/www/ultrazend-static
  DOMAIN: www.ultrazend.com.br

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: https://www.ultrazend.com.br
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 72.60.10.108 >> ~/.ssh/known_hosts

      - name: Deploy via SSH (Replicando local-deploy.sh)
        run: |
          ssh ${{ env.SERVER_HOST }} 'bash -s' < .github/scripts/deploy-production-remote.sh

      - name: Deploy Complete
        run: |
          echo "DEPLOY GITHUB ACTIONS CONCLUIDO!"
          echo "================================="
          echo "Site: https://${{ env.DOMAIN }}"
          echo "Monitorar: ssh ${{ env.SERVER_HOST }} 'pm2 list'"
          echo "Proximo deploy: Push to main branch"
