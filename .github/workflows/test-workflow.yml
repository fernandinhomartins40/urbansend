# ğŸ§ª Test Workflow - UltraZend CI/CD
# Workflow para testar antes do deploy principal

name: ğŸ§ª Test CI/CD Workflow

on:
  push:
    branches: [develop, feature/*]
  pull_request:
    branches: [main]
  
  workflow_dispatch:

jobs:
  # ===== TESTE DE BUILD =====
  build-test:
    name: ğŸ”¨ Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ§ª Build Image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t ultrazend:test .
          
          echo "ğŸ“Š Image built successfully"
          docker images ultrazend:test
      
      - name: ğŸ¥ Container Health Test
        run: |
          echo "ğŸ§ª Testing container health..."
          
          # Start container
          docker run -d --name health-test \
            -p 3010:3010 \
            -e NODE_ENV=test \
            ultrazend:test
          
          # Wait and test
          echo "â³ Waiting for container..."
          sleep 30
          
          # Health check
          if docker exec health-test curl -f http://localhost:3010/health; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            docker logs health-test --tail 50
            exit 1
          fi
          
          # Cleanup
          docker stop health-test
          docker rm health-test
          echo "ğŸ§¹ Cleanup completed"

  # ===== TESTE DE SEGURANÃ‡A =====
  security-test:
    name: ğŸ” Security Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Scan for Secrets
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          
          # Check for common secret patterns
          if grep -r -E "(password|secret|key|token).*=.*['\"][^'\"]{10,}['\"]" . --exclude-dir=.git --exclude="*.md" --exclude="*test*"; then
            echo "âš ï¸ Potential secrets found, please review"
          else
            echo "âœ… No obvious secrets found"
          fi
      
      - name: ğŸ“‹ Check Environment Files
        run: |
          echo "ğŸ“‹ Checking environment configuration..."
          
          if [ -f "docker/.env.production" ]; then
            echo "âœ… Production env file exists"
            
            # Check if default secrets are still in use
            if grep -q "sua_chave_jwt_super_secreta" docker/.env.production; then
              echo "âš ï¸ Default JWT secret detected - needs to be changed in production"
            fi
          fi

  # ===== TESTE DE CONFIGURAÃ‡ÃƒO =====
  config-test:
    name: âš™ï¸ Configuration Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Validate Docker Compose
        run: |
          echo "ğŸ”§ Validating Docker Compose files..."
          
          # Validate docker-compose.yml
          if docker-compose -f docker-compose.yml config > /dev/null; then
            echo "âœ… docker-compose.yml is valid"
          else
            echo "âŒ docker-compose.yml has errors"
            exit 1
          fi
          
          # Validate development compose
          if docker-compose -f docker-compose.dev.yml config > /dev/null; then
            echo "âœ… docker-compose.dev.yml is valid"
          else
            echo "âŒ docker-compose.dev.yml has errors"
            exit 1
          fi
      
      - name: ğŸ“‹ Check Required Files
        run: |
          echo "ğŸ“‹ Checking required files..."
          
          required_files=(
            "Dockerfile"
            "docker-compose.yml"
            "docker/nginx.conf"
            "docker/start.sh"
            "docker/.env.production"
            "scripts/deploy-vps.sh"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file is missing"
              exit 1
            fi
          done
      
      - name: ğŸŒ Validate Nginx Config
        run: |
          echo "ğŸŒ Validating Nginx configuration..."
          
          # Build image to test nginx config
          docker build -t ultrazend:config-test .
          
          # Test nginx config
          if docker run --rm ultrazend:config-test nginx -t; then
            echo "âœ… Nginx configuration is valid"
          else
            echo "âŒ Nginx configuration has errors"
            exit 1
          fi

  # ===== SIMULAÃ‡ÃƒO DE DEPLOY =====
  deploy-simulation:
    name: ğŸ­ Deploy Simulation
    runs-on: ubuntu-latest
    needs: [build-test, security-test, config-test]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ­ Simulate Deploy Steps
        run: |
          echo "ğŸ­ Simulating deploy process..."
          
          # Simulate image build
          echo "ğŸ“¦ Building image..."
          docker build -t ultrazend:deploy-test .
          
          # Simulate image save/load
          echo "ğŸ’¾ Saving image..."
          docker save ultrazend:deploy-test | gzip > ultrazend-test.tar.gz
          
          IMAGE_SIZE=$(du -h ultrazend-test.tar.gz | cut -f1)
          echo "ğŸ“Š Compressed image size: $IMAGE_SIZE"
          
          # Simulate load
          echo "ğŸ“¦ Loading image..."
          docker rmi ultrazend:deploy-test
          gunzip -c ultrazend-test.tar.gz | docker load
          
          # Simulate deployment
          echo "ğŸš€ Simulating deployment..."
          docker run -d --name deploy-simulation \
            -p 3011:3010 \
            ultrazend:deploy-test
          
          # Test deployment
          sleep 20
          if curl -f http://localhost:3011/health; then
            echo "âœ… Deploy simulation successful"
          else
            echo "âŒ Deploy simulation failed"
            docker logs deploy-simulation --tail 20
            exit 1
          fi
          
          # Cleanup
          docker stop deploy-simulation
          docker rm deploy-simulation
          rm ultrazend-test.tar.gz
          
          echo "âœ… Deploy simulation completed successfully"

  # ===== RESULTADO FINAL =====
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [build-test, security-test, config-test, deploy-simulation]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Test Report
        run: |
          echo "ğŸ“Š TEST SUMMARY REPORT"
          echo "====================="
          echo "ğŸ“… Date: $(date)"
          echo ""
          
          # Check results
          if [ "${{ needs.build-test.result }}" == "success" ]; then
            echo "âœ… Build Test: PASSED"
          else
            echo "âŒ Build Test: FAILED"
          fi
          
          if [ "${{ needs.security-test.result }}" == "success" ]; then
            echo "âœ… Security Test: PASSED"
          else
            echo "âŒ Security Test: FAILED"
          fi
          
          if [ "${{ needs.config-test.result }}" == "success" ]; then
            echo "âœ… Configuration Test: PASSED"
          else
            echo "âŒ Configuration Test: FAILED"
          fi
          
          if [ "${{ needs.deploy-simulation.result }}" == "success" ]; then
            echo "âœ… Deploy Simulation: PASSED"
          else
            echo "âŒ Deploy Simulation: FAILED"
          fi
          
          echo ""
          
          # Overall status
          if [ "${{ needs.build-test.result }}" == "success" ] && \
             [ "${{ needs.security-test.result }}" == "success" ] && \
             [ "${{ needs.config-test.result }}" == "success" ] && \
             [ "${{ needs.deploy-simulation.result }}" == "success" ]; then
            echo "ğŸ‰ ALL TESTS PASSED - Ready for deployment!"
            echo "ğŸš€ Workflow is ready for production use"
          else
            echo "âŒ SOME TESTS FAILED - Review before deployment"
            exit 1
          fi