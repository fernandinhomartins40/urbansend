# ğŸ§ª Test Workflow - UltraZend CI/CD (Node.js direto, sem Docker)
# Workflow para testar antes do deploy principal

name: ğŸ§ª Test CI/CD Workflow

on:
  push:
    branches: [develop, feature/*]
  pull_request:
    branches: [main]
  
  workflow_dispatch:

jobs:
  # ===== TESTE DE BUILD =====
  build-test:
    name: ğŸ”¨ Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ§ª Build Backend
        run: |
          echo "ğŸ”¨ Building backend..."
          cd backend
          npm ci
          npm run build
          echo "âœ… Backend build completed"
      
      - name: ğŸ§ª Build Frontend
        run: |
          echo "ğŸ”¨ Building frontend..."
          cd frontend
          npm ci
          npm run build
          echo "âœ… Frontend build completed"
      
      - name: ğŸ¥ Health Test
        run: |
          echo "ğŸ§ª Testing application startup..."
          cd backend
          
          # Test if application starts without errors
          timeout 10s npm run start:dev &
          APP_PID=$!
          
          echo "â³ Waiting for app to start..."
          sleep 5
          
          # Simple check if process is still running
          if kill -0 $APP_PID 2>/dev/null; then
            echo "âœ… Application starts successfully"
            kill $APP_PID
          else
            echo "âŒ Application failed to start"
            exit 1
          fi

  # ===== TESTE DE SEGURANÃ‡A =====
  security-test:
    name: ğŸ” Security Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Scan for Secrets
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          
          # Check for common secret patterns
          if grep -r -E "(password|secret|key|token).*=.*['\"][^'\"]{10,}['\"]" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" --exclude="*test*"; then
            echo "âš ï¸ Potential secrets found, please review"
          else
            echo "âœ… No obvious secrets found"
          fi
      
      - name: ğŸ“‹ Check Environment Files
        run: |
          echo "ğŸ“‹ Checking environment configuration..."
          
          if [ -f "configs/.env.production" ]; then
            echo "âœ… Production env file exists"
            
            # Check if default secrets are still in use
            if grep -q "sua_chave_jwt_super_secreta" configs/.env.production 2>/dev/null; then
              echo "âš ï¸ Default JWT secret detected - needs to be changed in production"
            fi
          fi

  # ===== TESTE DE CONFIGURAÃ‡ÃƒO =====
  config-test:
    name: âš™ï¸ Configuration Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Validate TypeScript Config
        run: |
          echo "ğŸ”§ Validating TypeScript configuration..."
          cd backend
          npx tsc --noEmit || echo "TypeScript validation failed"
      
      - name: ğŸ“‹ Check Required Files
        run: |
          echo "ğŸ“‹ Checking required files..."
          
          required_files=(
            "backend/src/index.ts"
            "backend/package.json"
            "frontend/package.json"
            "scripts/deploy.sh"
            "ecosystem.config.js"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file is missing"
              exit 1
            fi
          done
      
      - name: ğŸŒ Validate Package.json
        run: |
          echo "ğŸŒ Validating package.json files..."
          
          # Validate backend package.json
          if cd backend && npm run build --dry-run; then
            echo "âœ… Backend package.json is valid"
          else
            echo "âŒ Backend package.json has errors"
            exit 1
          fi
          
          # Validate frontend package.json
          if cd ../frontend && npm run build --dry-run; then
            echo "âœ… Frontend package.json is valid"
          else
            echo "âŒ Frontend package.json has errors"
            exit 1
          fi

  # ===== SIMULAÃ‡ÃƒO DE DEPLOY =====
  deploy-simulation:
    name: ğŸ­ Deploy Simulation
    runs-on: ubuntu-latest
    needs: [build-test, security-test, config-test]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ­ Simulate Deploy Steps
        run: |
          echo "ğŸ­ Simulating deploy process..."
          
          # Simulate build process
          echo "ğŸ“¦ Building application..."
          cd backend && npm ci && npm run build
          cd ../frontend && npm ci && npm run build
          
          # Check build artifacts
          echo "ğŸ“Š Checking build artifacts..."
          if [ -d "backend/dist" ]; then
            BACKEND_SIZE=$(du -sh backend/dist | cut -f1)
            echo "âœ… Backend build size: $BACKEND_SIZE"
          else
            echo "âŒ Backend build failed"
            exit 1
          fi
          
          if [ -d "frontend/dist" ]; then
            FRONTEND_SIZE=$(du -sh frontend/dist | cut -f1)
            echo "âœ… Frontend build size: $FRONTEND_SIZE"
          else
            echo "âŒ Frontend build failed"
            exit 1
          fi
          
          echo "âœ… Deploy simulation completed successfully"

  # ===== RESULTADO FINAL =====
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [build-test, security-test, config-test, deploy-simulation]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Test Report
        run: |
          echo "ğŸ“Š TEST SUMMARY REPORT"
          echo "====================="
          echo "ğŸ“… Date: $(date)"
          echo ""
          
          # Check results
          if [ "${{ needs.build-test.result }}" == "success" ]; then
            echo "âœ… Build Test: PASSED"
          else
            echo "âŒ Build Test: FAILED"
          fi
          
          if [ "${{ needs.security-test.result }}" == "success" ]; then
            echo "âœ… Security Test: PASSED"
          else
            echo "âŒ Security Test: FAILED"
          fi
          
          if [ "${{ needs.config-test.result }}" == "success" ]; then
            echo "âœ… Configuration Test: PASSED"
          else
            echo "âŒ Configuration Test: FAILED"
          fi
          
          if [ "${{ needs.deploy-simulation.result }}" == "success" ]; then
            echo "âœ… Deploy Simulation: PASSED"
          else
            echo "âŒ Deploy Simulation: FAILED"
          fi
          
          echo ""
          
          # Overall status
          if [ "${{ needs.build-test.result }}" == "success" ] && \
             [ "${{ needs.security-test.result }}" == "success" ] && \
             [ "${{ needs.config-test.result }}" == "success" ] && \
             [ "${{ needs.deploy-simulation.result }}" == "success" ]; then
            echo "ğŸ‰ ALL TESTS PASSED - Ready for deployment!"
            echo "ğŸš€ Workflow is ready for production use"
            echo ""
            echo "ğŸ¯ SIMPLIFIED ARCHITECTURE VALIDATED:"
            echo "  âœ… Node.js builds working"
            echo "  âœ… TypeScript compilation OK"
            echo "  âœ… No Docker dependencies"
            echo "  âœ… No Nginx configurations"
            echo "  âœ… Ready for PM2 + SSL deployment"
          else
            echo "âŒ SOME TESTS FAILED - Review before deployment"
            exit 1
          fi