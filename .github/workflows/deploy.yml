# ğŸš€ Direct VPS Deploy - UltraZend (No Docker)
# Direct deployment to VPS with nginx + PM2

name: ğŸš€ Deploy UltraZend Direct

on:
  push:
    branches: [main]
    paths-ignore: ['*.md', 'docs/**']
  workflow_dispatch:

env:
  VPS_HOST: 31.97.162.155
  VPS_USER: root
  DEPLOY_PATH: /var/www/ultrazend
  APP_DOMAIN: www.ultrazend.com.br

jobs:
  deploy:
    name: ğŸš€ Deploy Completo
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # ==================== PREPARAÃ‡ÃƒO ====================
      - name: ğŸ“¥ 1ï¸âƒ£ Checkout & Setup
        uses: actions/checkout@v4
        
      - name: ğŸ”§ 2ï¸âƒ£ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ 3ï¸âƒ£ Install Dependencies & Build
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias do backend..."
          cd backend && npm ci
          
          echo "ğŸ—ï¸ Construindo backend..."
          npm run build
          
          echo "ğŸ“¦ Instalando dependÃªncias do frontend..."
          cd ../frontend && npm ci
          
          echo "ğŸ—ï¸ Construindo frontend..."
          npm run build

      - name: ğŸ”§ 4ï¸âƒ£ Install SSH Tools
        run: |
          echo "ğŸ”§ Instalando ferramentas SSH..."
          sudo apt-get update -qq
          sudo apt-get install -y sshpass rsync
          
          echo "ğŸ” Testando conexÃ£o SSH..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            $VPS_USER@$VPS_HOST "echo 'âœ… SSH conectado com sucesso'"

      # ==================== PREPARAR VPS ====================
      - name: ğŸ› ï¸ 5ï¸âƒ£ Setup VPS Environment
        run: |
          echo "ğŸ› ï¸ Configurando ambiente da VPS..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'SCRIPT'
          set -e
          
          # Instalar Node.js se necessÃ¡rio
          if ! command -v node >/dev/null 2>&1; then
            echo "ğŸ“¦ Instalando Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt-get install -y nodejs
          else
            echo "âœ… Node.js jÃ¡ instalado: $(node -v)"
          fi
          
          # Instalar PM2 globalmente
          if ! command -v pm2 >/dev/null 2>&1; then
            echo "ğŸ“¦ Instalando PM2..."
            npm install -g pm2
          else
            echo "âœ… PM2 jÃ¡ instalado"
          fi
          
          # Instalar nginx se necessÃ¡rio
          if ! command -v nginx >/dev/null 2>&1; then
            echo "ğŸ“¦ Instalando nginx..."
            apt-get update
            apt-get install -y nginx
            systemctl enable nginx
          else
            echo "âœ… nginx jÃ¡ instalado"
          fi
          
          # Criar estrutura de diretÃ³rios
          echo "ğŸ“ Criando estrutura de diretÃ³rios..."
          mkdir -p /var/www/ultrazend/{backend,frontend,data,logs,backup}
          chown -R www-data:www-data /var/www/ultrazend
          chmod 755 /var/www/ultrazend
          
          echo "âœ… VPS configurada"
          SCRIPT

      # ==================== TRANSFERIR ARQUIVOS ====================
      - name: ğŸ“¤ 6ï¸âƒ£ Transfer Files
        run: |
          echo "ğŸ“¤ Enviando arquivos para VPS..."
          
          # Enviar backend build
          echo "ğŸ—ï¸ Enviando backend..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --delete \
            --exclude=node_modules backend/ $VPS_USER@$VPS_HOST:$DEPLOY_PATH/backend/
          
          # Enviar frontend build
          echo "ğŸŒ Enviando frontend..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --delete \
            frontend/dist/ $VPS_USER@$VPS_HOST:$DEPLOY_PATH/frontend/
          
          # Enviar configuraÃ§Ãµes
          echo "âš™ï¸ Enviando configuraÃ§Ãµes..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            configs/nginx-ssl.conf $VPS_USER@$VPS_HOST:/tmp/urbansend-nginx-ssl.conf
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            configs/ecosystem.config.js $VPS_USER@$VPS_HOST:$DEPLOY_PATH/
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            configs/.env.production $VPS_USER@$VPS_HOST:$DEPLOY_PATH/backend/.env
          
          echo "âœ… Todos os arquivos enviados"

      # ==================== CONFIGURAR PRODUÃ‡ÃƒO ====================
      - name: âš™ï¸ 7ï¸âƒ£ Configure Production
        run: |
          echo "âš™ï¸ Configurando ambiente de produÃ§Ã£o..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'CONFIG'
          set -e
          cd /var/www/ultrazend
          
          # Instalar dependÃªncias de produÃ§Ã£o no backend
          echo "ğŸ“¦ Instalando dependÃªncias de produÃ§Ã£o..."
          cd backend
          npm ci --only=production
          
          # Configurar nginx
          echo "ğŸŒ Configurando nginx..."
          cp /tmp/urbansend-nginx-ssl.conf /etc/nginx/sites-available/ultrazend
          ln -sf /etc/nginx/sites-available/ultrazend /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          nginx -t && systemctl reload nginx
          
          # Executar migraÃ§Ãµes do banco
          echo "ğŸ’¾ Executando migraÃ§Ãµes..."
          npm run migrate:latest || echo "MigraÃ§Ãµes nÃ£o encontradas ou falhou"
          
          echo "âœ… ConfiguraÃ§Ã£o de produÃ§Ã£o concluÃ­da"
          CONFIG

      # ==================== DEPLOY APLICAÃ‡ÃƒO ====================
      - name: ğŸš€ 8ï¸âƒ£ Deploy Application
        run: |
          echo "ğŸš€ Fazendo deploy da aplicaÃ§Ã£o..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'DEPLOY'
          set -e
          cd /var/www/ultrazend
          
          # Parar aplicaÃ§Ã£o existente
          echo "ğŸ›‘ Parando aplicaÃ§Ã£o existente..."
          pm2 delete ultrazend 2>/dev/null || echo "Nenhuma aplicaÃ§Ã£o rodando"
          
          # Iniciar aplicaÃ§Ã£o com PM2
          echo "â–¶ï¸ Iniciando aplicaÃ§Ã£o com PM2..."
          pm2 start ecosystem.config.js
          
          # Salvar configuraÃ§Ã£o PM2
          pm2 save
          pm2 startup | tail -1 | bash || echo "PM2 startup jÃ¡ configurado"
          
          # Aguardar inicializaÃ§Ã£o
          echo "â³ Aguardando inicializaÃ§Ã£o (15s)..."
          sleep 15
          
          # Verificar status
          echo "ğŸ” Verificando status da aplicaÃ§Ã£o..."
          pm2 status
          
          if pm2 list | grep -q "online"; then
            echo "âœ… AplicaÃ§Ã£o iniciada com sucesso"
          else
            echo "âŒ Falha ao iniciar aplicaÃ§Ã£o"
            echo ""
            echo "ğŸ“‹ Logs da aplicaÃ§Ã£o (PM2):"
            pm2 logs ultrazend --lines 30 || echo "Sem logs PM2"
            echo ""
            echo "ğŸ“‹ Status detalhado PM2:"
            pm2 describe ultrazend || echo "Processo nÃ£o encontrado"
            echo ""
            echo "ğŸ” Verificando arquivos dist:"
            ls -la backend/dist/ || echo "Pasta dist nÃ£o encontrada"
            echo ""
            echo "ğŸ” Verificando dependÃªncias:"
            ls -la backend/node_modules/ | head -10 || echo "node_modules nÃ£o encontrado"
            echo ""
            echo "ğŸ” Verificando .env:"
            ls -la backend/.env || echo ".env nÃ£o encontrado"
            echo ""
            echo "ğŸ” Verificando portas em uso:"
            netstat -tlnp | grep ":3001" || echo "Porta 3001 nÃ£o estÃ¡ em uso"
            echo ""
            echo "ğŸ” Tentando executar aplicaÃ§Ã£o manualmente:"
            cd backend && node dist/index.js 2>&1 | head -10 &
            sleep 3
            kill $! 2>/dev/null || echo "Processo jÃ¡ parou"
            exit 1
          fi
          
          echo "ğŸ‰ Deploy concluÃ­do!"
          DEPLOY

      # ==================== RESUMO FINAL ====================
      - name: ğŸ“Š 9ï¸âƒ£ Summary
        run: |
          echo ""
          echo "ğŸ‰ ===== DEPLOY CONCLUÃDO COM SUCESSO ====="
          echo ""
          echo "ğŸ“‹ INFORMAÃ‡Ã•ES DO DEPLOY:"
          echo "  ğŸŒ DomÃ­nio: www.ultrazend.com.br"
          echo "  ğŸ”Œ IP VPS: $VPS_HOST"
          echo "  ğŸšª Backend: Porta 3001 (via nginx)"
          echo "  ğŸŒ Frontend: nginx porta 80"
          echo "  ğŸ“§ SMTP: Porta 25"
          echo "  â° Deploy: $(date '+%d/%m/%Y %H:%M:%S')"
          echo ""
          echo "ğŸ”— URLS DISPONÃVEIS:"
          echo "  ğŸŒ App: https://www.ultrazend.com.br"
          echo "  ğŸ“± Direct IP: https://$VPS_HOST"
          echo ""
          echo "âœ… AplicaÃ§Ã£o UltraZend estÃ¡ online!"