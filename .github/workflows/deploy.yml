# ğŸš€ Deploy Simplificado - UrbanSend
# DomÃ­nio: www.urbanmail.com.br | VPS: 72.60.10.112:3010

name: ğŸš€ Deploy UrbanSend

on:
  push:
    branches: [main]
    paths-ignore: ['*.md', 'docs/**']
  workflow_dispatch:

env:
  VPS_HOST: 72.60.10.112
  VPS_USER: root
  VPS_PATH: /opt/urbansend
  APP_PORT: 3010

jobs:
  deploy:
    name: ğŸš€ Deploy Completo
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # ==================== PREPARAÃ‡ÃƒO ====================
      - name: ğŸ“¥ 1ï¸âƒ£ Checkout & Setup
        uses: actions/checkout@v4
        
      - name: ğŸ”§ 2ï¸âƒ£ Install Dependencies
        run: |
          echo "ğŸ”§ Instalando dependÃªncias..."
          sudo apt-get update -qq
          sudo apt-get install -y sshpass curl
          
          echo "ğŸ” Testando conexÃ£o SSH..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            $VPS_USER@$VPS_HOST "echo 'âœ… SSH conectado com sucesso'"

      # ==================== BUILD LOCAL ====================
      - name: ğŸ—ï¸ 3ï¸âƒ£ Build Docker Image
        run: |
          echo "ğŸ—ï¸ Construindo imagem Docker..."
          docker build -t urbansend:latest . --no-cache
          
          echo "ğŸ“Š Verificando imagem construÃ­da..."
          docker images | grep urbansend
          
          echo "ğŸ’¾ Exportando imagem..."
          docker save urbansend:latest | gzip > urbansend-image.tar.gz
          IMAGE_SIZE=$(du -h urbansend-image.tar.gz | cut -f1)
          echo "ğŸ“¦ Tamanho da imagem: $IMAGE_SIZE"

      # ==================== PREPARAR VPS ====================
      - name: ğŸ› ï¸ 4ï¸âƒ£ Setup VPS Environment
        run: |
          echo "ğŸ› ï¸ Configurando ambiente da VPS..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'SCRIPT'
          set -e
          
          # Instalar Docker se necessÃ¡rio
          if ! command -v docker >/dev/null 2>&1; then
            echo "ğŸ“¦ Instalando Docker..."
            curl -fsSL https://get.docker.com | sh
            systemctl enable docker
            systemctl start docker
          else
            echo "âœ… Docker jÃ¡ instalado"
          fi
          
          # Instalar Docker Compose
          if ! command -v docker-compose >/dev/null 2>&1; then
            echo "ğŸ“¦ Instalando Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-x86_64" \
              -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          else
            echo "âœ… Docker Compose jÃ¡ instalado"
          fi
          
          # Criar diretÃ³rios
          echo "ğŸ“ Criando diretÃ³rios..."
          mkdir -p /opt/urbansend/{data,logs,backup}
          chmod -R 755 /opt/urbansend
          
          echo "âœ… VPS configurada"
          SCRIPT

      # ==================== TRANSFERIR ARQUIVOS ====================
      - name: ğŸ“¤ 5ï¸âƒ£ Transfer Files
        run: |
          echo "ğŸ“¤ Enviando arquivos para VPS..."
          
          # Enviar imagem Docker
          echo "ğŸ³ Enviando imagem Docker..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            urbansend-image.tar.gz $VPS_USER@$VPS_HOST:$VPS_PATH/
          
          # Enviar docker-compose
          echo "ğŸ“‹ Enviando docker-compose.yml..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            docker-compose.yml $VPS_USER@$VPS_HOST:$VPS_PATH/
          
          # Enviar configuraÃ§Ãµes Docker
          echo "âš™ï¸ Enviando configuraÃ§Ãµes..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no -r \
            docker/ $VPS_USER@$VPS_HOST:$VPS_PATH/
          
          echo "âœ… Todos os arquivos enviados"

      # ==================== CONFIGURAR PRODUÃ‡ÃƒO ====================
      - name: âš™ï¸ 6ï¸âƒ£ Configure Production
        run: |
          echo "âš™ï¸ Configurando ambiente de produÃ§Ã£o..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'CONFIG'
          cd /opt/urbansend
          
          # Criar .env de produÃ§Ã£o
          cat > docker/.env.production << 'ENV'
          NODE_ENV=production
          PORT=3001
          INTERNAL_PORT=3010
          DOMAIN=www.urbanmail.com.br
          PUBLIC_URL=http://www.urbanmail.com.br
          API_URL=http://www.urbanmail.com.br/api
          DATABASE_URL=/app/data/database.sqlite
          JWT_SECRET=urbansend_jwt_secret_key_production_2024_secure_32_chars_minimum
          COOKIE_SECRET=urbansend_cookie_secret_production_2024_secure_32_chars_min
          API_KEY_SALT=urbansend_api_key_salt_production_2024_secure_32_chars_min
          ALLOWED_ORIGINS=http://www.urbanmail.com.br,https://www.urbanmail.com.br
          SMTP_SERVER_PORT=25
          SMTP_HOSTNAME=www.urbanmail.com.br
          FROM_EMAIL=noreply@urbanmail.com.br
          FROM_NAME=UrbanMail
          LOG_LEVEL=info
          RATE_LIMIT_MAX_REQUESTS=100
          ENV
          
          # Tornar scripts executÃ¡veis
          chmod +x docker/start.sh 2>/dev/null || true
          
          echo "âœ… ConfiguraÃ§Ã£o de produÃ§Ã£o criada"
          CONFIG

      # ==================== DEPLOY APLICAÃ‡ÃƒO ====================
      - name: ğŸš€ 7ï¸âƒ£ Deploy Application
        run: |
          echo "ğŸš€ Fazendo deploy da aplicaÃ§Ã£o..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'DEPLOY'
          set -e
          cd /opt/urbansend
          
          # Parar aplicaÃ§Ã£o existente
          echo "ğŸ›‘ Parando aplicaÃ§Ã£o existente..."
          docker-compose down --remove-orphans 2>/dev/null || true
          docker system prune -f >/dev/null 2>&1 || true
          
          # Carregar nova imagem
          echo "ğŸ“¦ Carregando nova imagem Docker..."
          gunzip -c urbansend-image.tar.gz | docker load
          
          # Iniciar aplicaÃ§Ã£o
          echo "â–¶ï¸ Iniciando nova aplicaÃ§Ã£o..."
          docker-compose up -d
          
          # Aguardar inicializaÃ§Ã£o
          echo "â³ Aguardando inicializaÃ§Ã£o (30s)..."
          sleep 30
          
          # Verificar status
          echo "ğŸ” Verificando status dos containers..."
          docker-compose ps
          
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… AplicaÃ§Ã£o iniciada com sucesso"
          else
            echo "âŒ Falha ao iniciar aplicaÃ§Ã£o"
            echo "ğŸ“‹ Logs dos containers:"
            docker-compose logs --tail 30
            exit 1
          fi
          
          # Limpeza
          rm -f urbansend-image.tar.gz
          echo "ğŸ‰ Deploy concluÃ­do!"
          DEPLOY

      # ==================== VERIFICAÃ‡Ã•ES FINAIS ====================
      - name: ğŸ§ª 8ï¸âƒ£ Health Check
        run: |
          echo "ğŸ§ª Executando verificaÃ§Ãµes de saÃºde..."
          
          # Aguardar estabilizaÃ§Ã£o
          sleep 15
          
          # Testar endpoint de saÃºde
          echo "ğŸ¥ Testando endpoint /health..."
          HEALTH_OK=false
          
          for i in {1..10}; do
            echo "ğŸ”„ Tentativa $i/10..."
            
            if curl -f --connect-timeout 5 --max-time 10 "http://$VPS_HOST:$APP_PORT/health" 2>/dev/null; then
              echo "âœ… Health check passou na tentativa $i"
              HEALTH_OK=true
              break
            fi
            
            if [ $i -lt 10 ]; then
              sleep 10
            fi
          done
          
          if [ "$HEALTH_OK" = false ]; then
            echo "âŒ Health check falhou apÃ³s 10 tentativas"
            echo "ğŸ” Verificando status da VPS..."
            sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST \
              "cd /opt/urbansend && docker-compose logs --tail 20"
            exit 1
          fi
          
          # Testar pÃ¡gina principal
          echo "ğŸŒ Testando pÃ¡gina principal..."
          if curl -f --connect-timeout 5 --max-time 10 "http://$VPS_HOST:$APP_PORT/" >/dev/null 2>&1; then
            echo "âœ… PÃ¡gina principal respondendo"
          else
            echo "âš ï¸ PÃ¡gina principal nÃ£o responde (pode ser normal)"
          fi

      # ==================== RESUMO FINAL ====================
      - name: ğŸ“Š 9ï¸âƒ£ Summary
        run: |
          echo ""
          echo "ğŸ‰ ===== DEPLOY CONCLUÃDO COM SUCESSO ====="
          echo ""
          echo "ğŸ“‹ INFORMAÃ‡Ã•ES DO DEPLOY:"
          echo "  ğŸŒ DomÃ­nio: www.urbanmail.com.br"
          echo "  ğŸ”Œ IP VPS: $VPS_HOST"
          echo "  ğŸšª Porta: $APP_PORT"
          echo "  ğŸ“§ SMTP: Porta 25"
          echo "  â° Deploy: $(date '+%d/%m/%Y %H:%M:%S')"
          echo ""
          echo "ğŸ”— URLS DISPONÃVEIS:"
          echo "  ğŸ“± App: http://$VPS_HOST:$APP_PORT"
          echo "  ğŸ¥ Health: http://$VPS_HOST:$APP_PORT/health"
          echo "  ğŸŒ DomÃ­nio: http://www.urbanmail.com.br:$APP_PORT"
          echo ""
          echo "âœ… AplicaÃ§Ã£o UrbanSend estÃ¡ online!"