name: üöÄ Deploy UrbanSend Production

concurrency:
  group: urbansend-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.112'
  VPS_USER: 'root'
  APP_DIR: '/var/www/urbansend'
  DOMAIN: 'www.urbanmail.com.br'

jobs:
  deploy:
    name: üéØ Deploy to Production VPS
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: üìã Deploy Information
      run: |
        echo "=============================================="
        echo "üöÄ URBANSEND PRODUCTION DEPLOYMENT"
        echo "=============================================="
        echo "üì¶ Commit: ${{ github.sha }}"
        echo "üåø Branch: ${{ github.ref_name }}"
        echo "üë§ Actor: ${{ github.actor }}"
        echo "‚è∞ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "üéØ Target: ${{ env.VPS_HOST }}"
        echo "üåê Domain: ${{ env.DOMAIN }}"
        echo "=============================================="
        
        echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: üîß Configure SSH
      run: |
        echo "üîß Configurando SSH..."
        sudo apt-get update -qq
        sudo apt-get install -y sshpass rsync
        
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "üîê Testando conex√£o SSH..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo '‚úÖ SSH OK'"; then
          echo "‚úÖ SSH configurado com sucesso"
        else
          echo "‚ùå Falha na conex√£o SSH"
          exit 1
        fi

    - name: üèóÔ∏è Build Backend
      run: |
        echo "üèóÔ∏è Building backend..."
        cd backend
        
        if [ -f "package-lock.json" ]; then
          npm ci --no-audit --no-fund
        else
          npm install --no-audit --no-fund
        fi
        
        echo "üî® Compilando TypeScript..."
        npm run build
        
        echo "‚úÖ Backend build completo"
        ls -la dist/

    - name: ‚öõÔ∏è Build Frontend
      run: |
        echo "‚öõÔ∏è Building frontend..."
        cd frontend
        
        if [ -f "package-lock.json" ]; then
          npm ci --no-audit --no-fund
        else
          npm install --no-audit --no-fund
        fi
        
        echo "üî® Compilando React/Vite..."
        npm run build
        
        echo "‚úÖ Frontend build completo"
        ls -la dist/
        
        if [ ! -f "dist/index.html" ]; then
          echo "‚ùå index.html n√£o encontrado"
          exit 1
        fi

    - name: üßπ Prepare VPS Environment
      run: |
        echo "üßπ Preparando ambiente VPS..."
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'üîÑ Atualizando sistema...'
        apt-get update -y > /dev/null 2>&1
        
        echo 'üê≥ Instalando Docker...'
        if ! command -v docker >/dev/null; then
          curl -fsSL https://get.docker.com -o get-docker.sh
          sh get-docker.sh > /dev/null 2>&1
          rm get-docker.sh
          systemctl start docker
          systemctl enable docker
        fi
        
        echo 'üîß Instalando Docker Compose Plugin...'
        if ! docker compose version >/dev/null 2>&1; then
          apt-get install -y docker-compose-plugin > /dev/null 2>&1
        fi
        
        echo 'üî• Configurando firewall...'
        ufw allow 3010/tcp comment 'UrbanSend App' 2>/dev/null || true
        ufw allow 25/tcp comment 'UrbanSend SMTP' 2>/dev/null || true
        ufw allow 80/tcp comment 'HTTP' 2>/dev/null || true
        ufw allow 443/tcp comment 'HTTPS' 2>/dev/null || true
        
        echo '‚úÖ Ambiente preparado'
        docker --version
        docker compose version
        "

    - name: üõë Stop Old Deployment
      run: |
        echo "üõë Parando deployment anterior..."
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }} 2>/dev/null || true
        
        if [ -f 'docker-compose.production.yml' ]; then
          echo 'üõë Parando containers...'
          docker compose -f docker-compose.production.yml down --remove-orphans 2>/dev/null || true
        fi
        
        echo 'üßπ Limpando containers antigos...'
        docker container prune -f 2>/dev/null || true
        docker image prune -f 2>/dev/null || true
        
        echo 'üìÅ Preparando diret√≥rio...'
        rm -rf ${{ env.APP_DIR }}
        mkdir -p ${{ env.APP_DIR }}
        
        echo '‚úÖ Limpeza conclu√≠da'
        "

    - name: üì§ Deploy Application
      run: |
        echo "üì§ Enviando aplica√ß√£o..."
        
        echo "üì¶ Copiando arquivos..."
        sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no -r \
          backend/dist ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/backend-dist
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no -r \
          frontend/dist ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/frontend-dist
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
          backend/package.json \
          backend/knexfile.js \
          backend/knexfile.d.ts \
          ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no -r \
          backend/src/migrations ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
          docker-compose.production.yml \
          .env.production \
          nginx.conf \
          ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/

    - name: üöÄ Start Production Services
      run: |
        echo "üöÄ Iniciando servi√ßos..."
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        
        echo 'üì¶ Instalando depend√™ncias de produ√ß√£o...'
        npm ci --omit=dev --no-audit --no-fund
        
        echo 'üê≥ Iniciando containers...'
        docker compose -f docker-compose.production.yml up -d --build
        
        echo '‚è≥ Aguardando inicializa√ß√£o (60s)...'
        sleep 60
        
        echo 'üóÑÔ∏è Executando migra√ß√µes...'
        docker compose -f docker-compose.production.yml exec -T urbansend sh -c 'cd /app/backend && npm run migrate:latest' || echo 'Migra√ß√µes j√° executadas'
        
        echo 'üìä Status dos containers:'
        docker compose -f docker-compose.production.yml ps
        
        echo '‚úÖ Servi√ßos iniciados'
        "

    - name: üîß Configure Nginx Reverse Proxy
      run: |
        echo "üîß Configurando Nginx..."
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'üìù Criando configura√ß√£o Nginx...'
        cat > /etc/nginx/sites-available/${{ env.DOMAIN }} << 'EOF'
server {
    listen 80;
    server_name ${{ env.DOMAIN }};
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${{ env.DOMAIN }};

    # SSL certificates (configure manually)
    ssl_certificate /etc/letsencrypt/live/${{ env.DOMAIN }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${{ env.DOMAIN }}/privkey.pem;
    
    # SSL security
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains; preload\";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection \"1; mode=block\";

    # Proxy to application
    location / {
        proxy_pass http://localhost:3010;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        proxy_read_timeout 86400;
    }

    # API routes
    location /api/ {
        proxy_pass http://localhost:3010/api/;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_read_timeout 86400;
    }
}
EOF

        echo 'üîó Ativando site...'
        ln -sf /etc/nginx/sites-available/${{ env.DOMAIN }} /etc/nginx/sites-enabled/
        rm -f /etc/nginx/sites-enabled/default
        
        echo 'üîç Testando configura√ß√£o...'
        if nginx -t; then
          echo '‚úÖ Nginx configura√ß√£o OK'
          systemctl reload nginx
        else
          echo '‚ö†Ô∏è Nginx configura√ß√£o com problemas, mas continuando...'
        fi
        "

    - name: üè• Health Checks
      run: |
        echo "üè• Executando health checks..."
        
        # Fun√ß√£o para health check com retry
        health_check() {
          local url=$1
          local name=$2
          local max_attempts=20
          local delay=15
          
          echo "üîç Verificando $name..."
          
          for attempt in $(seq 1 $max_attempts); do
            echo "‚è≥ Tentativa $attempt/$max_attempts - $name"
            
            if curl -s -f "$url" >/dev/null; then
              echo "‚úÖ $name: OK"
              return 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              sleep $delay
            fi
          done
          
          echo "‚ùå $name: Falhou ap√≥s $max_attempts tentativas"
          return 1
        }
        
        echo "‚è≥ Aguardando inicializa√ß√£o (60s)..."
        sleep 60
        
        # Health check da aplica√ß√£o
        if health_check "http://${{ env.VPS_HOST }}:3010/health" "UrbanSend App"; then
          echo "‚úÖ Aplica√ß√£o respondendo"
        else
          echo "‚ùå Aplica√ß√£o n√£o responde"
          
          echo "üîç Coletando logs para diagn√≥stico..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.APP_DIR }}
          echo 'üìã Status dos containers:'
          docker compose -f docker-compose.production.yml ps
          echo 'üìù Logs da aplica√ß√£o:'
          docker compose -f docker-compose.production.yml logs urbansend --tail=50
          "
          exit 1
        fi
        
        # Verificar porta SMTP
        echo "üîç Verificando servidor SMTP..."
        if timeout 10 bash -c "</dev/tcp/${{ env.VPS_HOST }}/25" 2>/dev/null; then
          echo "‚úÖ Servidor SMTP respondendo"
        else
          echo "‚ö†Ô∏è Servidor SMTP pode n√£o estar acess√≠vel externamente"
        fi

    - name: ‚úÖ Deployment Success
      if: success()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "üéâ DEPLOY CONCLU√çDO COM SUCESSO!"
        echo "================================"
        echo "‚è±Ô∏è  Tempo total: $DURATION_FORMATTED"
        echo "üåê Aplica√ß√£o: https://${{ env.DOMAIN }}"
        echo "üîå Endpoint: http://${{ env.VPS_HOST }}:3010"
        echo "üìß SMTP: ${{ env.VPS_HOST }}:25"
        echo "üè• Health: http://${{ env.VPS_HOST }}:3010/health"
        echo ""
        echo "üîß Para SSL, execute:"
        echo "sudo certbot --nginx -d ${{ env.DOMAIN }}"
        echo ""
        echo "üéä URBANSEND ONLINE! üéä"

    - name: ‚ùå Deployment Failed
      if: failure()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "‚ùå DEPLOY FALHOU!"
        echo "================="
        echo "‚è±Ô∏è  Tempo at√© falha: $DURATION_FORMATTED"
        echo "üîç Verifique os logs acima para diagn√≥stico"
        echo ""
        echo "üîß Diagn√≥stico adicional:"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'üìã Containers em execu√ß√£o:'
        docker ps -a
        echo 'üíæ Uso de disco:'
        df -h
        echo 'üß† Uso de mem√≥ria:'
        free -h
        echo 'üîç Portas em uso:'
        netstat -tlnp | grep -E ':(3010|25|6379)'
        " 2>/dev/null || echo "N√£o foi poss√≠vel conectar √† VPS para diagn√≥stico"
        
        exit 1