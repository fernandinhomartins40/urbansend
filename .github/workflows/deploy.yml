name: üöÄ Deploy UrbanSend Email System

concurrency:
  group: urbansend-production-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '72.60.10.112'
  VPS_USER: 'root'
  APP_DIR: '/root/urbansend'
  APP_PORT: '3010'
  SMTP_PORT: '25'
  CONTAINER_NAME: 'urbansend_app'
  REDIS_PORT: '6380'

jobs:
  deploy:
    name: üéØ Deploy UrbanSend Container
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: üìã Informa√ß√µes do Deploy
      run: |
        echo "=============================================="
        echo "üöÄ INICIANDO DEPLOY URBANSEND EMAIL SYSTEM"
        echo "=============================================="
        echo "üì¶ Commit: ${{ github.sha }}"
        echo "üåø Branch: ${{ github.ref_name }}"
        echo "üë§ Actor: ${{ github.actor }}"
        echo "‚è∞ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        echo "üéØ Target: ${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "üìß SMTP: ${{ env.VPS_HOST }}:${{ env.SMTP_PORT }}"
        echo "üîÑ Redis: Port ${{ env.REDIS_PORT }}"
        echo "=============================================="
        
        # Vari√°vel para tracking do tempo
        echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: üîß Configurar SSH e Ferramentas
      run: |
        echo "üîß Configurando SSH e ferramentas necess√°rias..."
        sudo apt-get update -qq
        sudo apt-get install -y sshpass rsync curl jq
        
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "üîê Testando conex√£o SSH..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo '‚úÖ SSH funcionando'"; then
          echo "‚úÖ SSH configurado com sucesso"
        else
          echo "‚ùå Falha na conex√£o SSH"
          exit 1
        fi

    - name: üì• Checkout do C√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: üì¶ Cache npm dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          frontend/node_modules
          backend/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: üìä An√°lise Pre-Deploy
      run: |
        echo "üìä Analisando estrutura do projeto UrbanSend..."
        echo "============================================="
        
        echo "üìÅ Estrutura raiz:"
        ls -la
        
        echo ""
        echo "üìÅ Backend:"
        if [ -d "backend" ]; then
          ls -la backend/
          if [ -f "backend/package.json" ]; then
            echo "‚úÖ package.json encontrado"
            echo "üì¶ Depend√™ncias principais:"
            cat backend/package.json | jq -r '.dependencies | keys | .[]' | head -5
            echo "üîß Scripts dispon√≠veis:"
            cat backend/package.json | jq -r '.scripts | keys | .[]'
          fi
        else
          echo "‚ùå Diret√≥rio backend n√£o encontrado"
          exit 1
        fi
        
        echo ""
        echo "üìÅ Frontend:"
        if [ -d "frontend" ]; then
          ls -la frontend/
          if [ -f "frontend/package.json" ]; then
            echo "‚úÖ package.json encontrado"
            echo "üì¶ Depend√™ncias principais:"
            cat frontend/package.json | jq -r '.dependencies | keys | .[]' | head -5
            echo "üîß Scripts dispon√≠veis:"
            cat frontend/package.json | jq -r '.scripts | keys | .[]'
          fi
        else
          echo "‚ùå Diret√≥rio frontend n√£o encontrado"
          exit 1
        fi
        
        echo ""
        echo "üê≥ Docker:"
        ls -la Dockerfile docker-compose.production.yml nginx.conf 2>/dev/null || echo "‚ö†Ô∏è Alguns arquivos Docker podem estar ausentes"
        
        echo ""
        echo "üìß SMTP Server:"
        if grep -r "smtp" backend/src/ >/dev/null 2>&1; then
          echo "‚úÖ Servidor SMTP encontrado no backend"
        else
          echo "‚ö†Ô∏è Servidor SMTP pode n√£o estar configurado"
        fi

    - name: üèóÔ∏è Build Local do Backend
      run: |
        echo "üèóÔ∏è Iniciando build local do backend UrbanSend..."
        echo "==============================================="
        
        cd backend
        
        echo "üì¶ Instalando depend√™ncias do backend..."
        if [ -f "package-lock.json" ]; then
          echo "üîí Usando package-lock.json com npm ci"
          npm ci
        else
          echo "üì¶ package-lock.json n√£o encontrado, usando npm install"
          npm install
        fi
        echo "‚úÖ Depend√™ncias do backend instaladas"
        
        echo "üî® Compilando TypeScript..."
        if npm run build; then
          echo "‚úÖ Build do backend conclu√≠do com sucesso"
          echo "üìä Analisando build:"
          ls -la dist/
          echo "üìà Tamanho do build: $(du -sh dist/)"
          echo "üìù Arquivos gerados: $(find dist/ -type f | wc -l)"
          echo "üìß Verificando SMTP server:"
          find dist/ -name "*smtp*" -o -name "*mail*" | head -5
        else
          echo "‚ùå Falha no build do backend"
          exit 1
        fi

    - name: ‚öõÔ∏è Build Local do Frontend  
      run: |
        echo "‚öõÔ∏è Iniciando build local do frontend UrbanSend..."
        echo "================================================"
        
        cd frontend
        
        echo "üì¶ Instalando depend√™ncias do frontend..."
        if [ -f "package-lock.json" ]; then
          echo "üîí Usando package-lock.json com npm ci"
          npm ci
        else
          echo "üì¶ package-lock.json n√£o encontrado, usando npm install"
          npm install
        fi
        echo "‚úÖ Depend√™ncias do frontend instaladas"
        
        echo "üî® Compilando React/Vite..."
        if npm run build; then
          echo "‚úÖ Build do frontend conclu√≠do com sucesso"
          echo "üìä Analisando build:"
          ls -la dist/
          echo "üìà Tamanho do build: $(du -sh dist/)"
          echo "üìù Arquivos gerados: $(find dist/ -type f | wc -l)"
          
          # Verificar se arquivos essenciais foram gerados
          if [ -f "dist/index.html" ]; then
            echo "‚úÖ index.html encontrado"
          else
            echo "‚ùå index.html n√£o encontrado"
            exit 1
          fi
        else
          echo "‚ùå Falha no build do frontend"
          exit 1
        fi

    - name: üßπ Preparar VPS para UrbanSend
      run: |
        echo "üßπ Preparando ambiente UrbanSend na VPS..."
        echo "========================================="
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'üîÑ Atualizando sistema...'
        apt-get update -y > /dev/null 2>&1
        
        echo 'üü¢ Verificando Node.js 20.x...'
        if ! command -v node >/dev/null || [ \$(node --version | cut -d'v' -f2 | cut -d'.' -f1) -lt 20 ]; then
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash - > /dev/null 2>&1
          apt-get install -y nodejs > /dev/null 2>&1
        fi
        
        echo 'üê≥ Configurando Docker...'
        if ! command -v docker >/dev/null; then
          apt-get remove -y docker docker-engine docker.io containerd runc containerd.io 2>/dev/null || true
          apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release > /dev/null 2>&1
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg 2>/dev/null
          echo \"deb [arch=\$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          apt-get update -y > /dev/null 2>&1
          apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin > /dev/null 2>&1
          systemctl start docker
          systemctl enable docker
        fi
        
        echo 'üìß Configurando portas para SMTP...'
        ufw allow ${{ env.SMTP_PORT }}/tcp comment 'UrbanSend SMTP' 2>/dev/null || true
        ufw allow ${{ env.APP_PORT }}/tcp comment 'UrbanSend App' 2>/dev/null || true
        ufw allow ${{ env.REDIS_PORT }}/tcp comment 'UrbanSend Redis' 2>/dev/null || true
        
        echo '‚úÖ Vers√µes instaladas:'
        node --version
        npm --version
        docker --version
        "

    - name: üßπ Limpeza de Containers UrbanSend
      run: |
        echo "üßπ Removendo containers UrbanSend antigos..."
        echo "==========================================="
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'üõë Parando containers UrbanSend...'
        
        # Usar docker-compose para parar na pasta espec√≠fica
        cd ${{ env.APP_DIR }} 2>/dev/null && docker-compose -f docker-compose.production.yml down --remove-orphans 2>/dev/null || true
        
        # Parar containers espec√≠ficos do UrbanSend
        docker stop urbansend_app urbansend_redis urbansend_redis_ui 2>/dev/null && echo '‚úÖ Containers UrbanSend parados' || echo '‚ÑπÔ∏è  Nenhum container UrbanSend rodando'
        docker rm urbansend_app urbansend_redis urbansend_redis_ui 2>/dev/null && echo '‚úÖ Containers UrbanSend removidos' || echo '‚ÑπÔ∏è  Nenhum container UrbanSend para remover'
        
        echo 'üóëÔ∏è  Removendo imagens UrbanSend antigas...'
        docker rmi urbansend_urbansend_app:latest urbansend-redis:latest 2>/dev/null && echo '‚úÖ Imagens UrbanSend removidas' || echo '‚ÑπÔ∏è  Nenhuma imagem UrbanSend para remover'
        
        echo 'üßΩ Limpeza espec√≠fica do UrbanSend...'
        docker network rm urbansend_network 2>/dev/null && echo '‚úÖ Network UrbanSend removida' || echo '‚ÑπÔ∏è  Network n√£o encontrada'
        
        echo 'üìÅ Preparando diret√≥rio UrbanSend...'
        rm -rf ${{ env.APP_DIR }}
        mkdir -p ${{ env.APP_DIR }}
        echo '‚úÖ Diret√≥rio UrbanSend preparado'
        "

    - name: üì§ Transferir C√≥digo UrbanSend para VPS
      run: |
        echo "üì§ Transferindo c√≥digo UrbanSend para VPS..."
        echo "==========================================="
        
        echo "üìä Analisando arquivos a transferir..."
        echo "Tamanho total: $(du -sh . | cut -f1)"
        
        echo "üöÄ Iniciando transfer√™ncia UrbanSend..."
        if sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --progress --delete \
          --exclude='.git/' \
          --exclude='node_modules/' \
          --exclude='frontend/node_modules/' \
          --exclude='backend/node_modules/' \
          --exclude='.claude/' \
          --exclude='deploy.yml' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.APP_DIR }}/; then
          echo "‚úÖ C√≥digo UrbanSend transferido com sucesso"
        else
          echo "‚ùå Falha na transfer√™ncia"
          exit 1
        fi

    - name: üê≥ Build e Deploy Container UrbanSend
      run: |
        echo "üê≥ Construindo e deployando container UrbanSend..."
        echo "================================================="
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        
        echo 'üìã Verificando estrutura transferida...'
        ls -la
        
        echo 'üîç Verificando arquivos Docker...'
        ls -la Dockerfile docker-compose.production.yml nginx.conf 2>/dev/null || echo '‚ö†Ô∏è Alguns arquivos Docker podem estar ausentes'
        
        echo 'üèóÔ∏è Construindo container UrbanSend (isso pode levar alguns minutos)...'
        if docker-compose -f docker-compose.production.yml build --no-cache; then
          echo '‚úÖ Container UrbanSend constru√≠do com sucesso'
        else
          echo '‚ùå Falha na constru√ß√£o do container UrbanSend'
          exit 1
        fi
        
        echo 'üöÄ Iniciando container UrbanSend...'
        if docker-compose -f docker-compose.production.yml up -d; then
          echo '‚úÖ Container UrbanSend iniciado'
        else
          echo '‚ùå Falha ao iniciar container UrbanSend'
          exit 1
        fi
        
        echo 'üìä Status dos containers UrbanSend:'
        docker-compose -f docker-compose.production.yml ps
        "

    - name: üîß Configurar Nginx para UrbanSend
      run: |
        echo "üîß Configurando Nginx para UrbanSend..."
        echo "======================================"
        
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'üîß Atualizando configura√ß√£o do nginx para porta ${{ env.APP_PORT }}...'
        sed -i 's/localhost:3020/localhost:${{ env.APP_PORT }}/g' /etc/nginx/sites-available/urbanmail.com.br 2>/dev/null || true
        sed -i 's/localhost:3011/localhost:${{ env.APP_PORT }}/g' /etc/nginx/sites-available/urbanmail.com.br 2>/dev/null || true
        
        echo 'üîç Testando configura√ß√£o do nginx...'
        if nginx -t; then
          echo '‚úÖ Configura√ß√£o do nginx v√°lida'
          systemctl reload nginx
          echo '‚úÖ Nginx recarregado'
        else
          echo '‚ö†Ô∏è Problema na configura√ß√£o do nginx, mas continuando...'
        fi
        "

    - name: üè• Health Checks UrbanSend
      run: |
        echo "üè• Executando health checks UrbanSend..."
        echo "======================================="
        
        # Fun√ß√£o para health check com retry
        health_check() {
          local url=$1
          local name=$2
          local max_attempts=20
          local delay=15
          
          echo "üîç Verificando $name..."
          
          for attempt in $(seq 1 $max_attempts); do
            local total_wait=$((attempt * delay))
            echo "‚è≥ Tentativa $attempt/$max_attempts (${total_wait}s total) - $name"
            
            local response=$(curl -s -o /dev/null -w "%{http_code}|%{time_total}" "$url" 2>/dev/null || echo "000|0")
            local http_code=$(echo $response | cut -d'|' -f1)
            local time_total=$(echo $response | cut -d'|' -f2)
            
            case $http_code in
              200)
                echo "‚úÖ $name: Respondendo corretamente (${time_total}s)"
                return 0
                ;;
              000)
                echo "‚è≥ $name: Servi√ßo ainda n√£o responde..."
                ;;
              *)
                echo "‚ö†Ô∏è  $name: HTTP $http_code (aguardando...)"
                ;;
            esac
            
            if [ $attempt -lt $max_attempts ]; then
              sleep $delay
            fi
          done
          
          echo "‚ùå $name: Falhou ap√≥s ${max_attempts} tentativas (${total_wait}s total)"
          return 1
        }
        
        echo ""
        echo "üè• Aguardando inicializa√ß√£o completa UrbanSend (90s)..."
        sleep 90
        
        # Health check da aplica√ß√£o unificada
        if health_check "http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health" "UrbanSend App"; then
          echo "‚úÖ UrbanSend est√° funcionando!"
        else
          echo "‚ùå UrbanSend n√£o est√° respondendo"
          URBANSEND_FAILED=1
        fi
        
        echo ""
        
        # Verificar porta SMTP
        echo "üîç Verificando servidor SMTP na porta ${{ env.SMTP_PORT }}..."
        if timeout 10 bash -c "</dev/tcp/${{ env.VPS_HOST }}/${{ env.SMTP_PORT }}" 2>/dev/null; then
          echo "‚úÖ Servidor SMTP respondendo na porta ${{ env.SMTP_PORT }}"
        else
          echo "‚ö†Ô∏è Servidor SMTP pode n√£o estar respondendo na porta ${{ env.SMTP_PORT }}"
        fi
        
        # Verificar logs se houver falha
        if [ "${URBANSEND_FAILED}" = "1" ]; then
          echo ""
          echo "üîç Coletando logs UrbanSend para diagn√≥stico..."
          echo "============================================="
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.APP_DIR }}
          echo 'üìã Status dos containers UrbanSend:'
          docker-compose -f docker-compose.production.yml ps
          echo ''
          echo 'üìù Logs recentes UrbanSend (√∫ltimas 50 linhas):'
          docker-compose -f docker-compose.production.yml logs --tail=50
          "
          
          exit 1
        fi

    - name: ‚úÖ Verifica√ß√£o Final UrbanSend
      if: success()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "üéâ URBANSEND DEPLOY CONCLU√çDO COM SUCESSO!"
        echo "=========================================="
        echo "‚è±Ô∏è  Tempo total: $DURATION_FORMATTED"
        echo "üåê Aplica√ß√£o: https://urbanmail.com.br"
        echo "üîå Endpoint: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}"
        echo "üìß SMTP Server: ${{ env.VPS_HOST }}:${{ env.SMTP_PORT }}"
        echo "üîÑ Redis: Port ${{ env.REDIS_PORT }}"
        echo "üè• Health Check: http://${{ env.VPS_HOST }}:${{ env.APP_PORT }}/health"
        echo "üìä Status: ONLINE ‚úÖ"
        echo ""
        
        # Verifica√ß√£o final dos servi√ßos UrbanSend
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        cd ${{ env.APP_DIR }}
        echo 'üìä Status final dos containers UrbanSend:'
        docker ps --filter 'name=urbansend' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
        echo ''
        echo 'üíæ Uso de recursos UrbanSend:'
        docker stats --no-stream --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}' \$(docker ps --filter 'name=urbansend' -q) 2>/dev/null || echo 'Containers ainda inicializando...'
        echo ''
        echo 'üîç Portas em uso:'
        netstat -tlnp | grep -E ':(${{ env.APP_PORT }}|${{ env.SMTP_PORT }}|${{ env.REDIS_PORT }})' || echo 'Verificando portas...'
        "
        
        echo ""
        echo "üéäüéäüéä URBANSEND DEPLOY FINALIZADO COM SUCESSO! üéäüéäüéä"

    - name: ‚ùå Deploy Failed - Diagn√≥stico UrbanSend
      if: failure()
      run: |
        DEPLOY_END_TIME=$(date +%s)
        DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
        DURATION_FORMATTED=$(printf '%02d:%02d:%02d' $((DEPLOY_DURATION/3600)) $((DEPLOY_DURATION%3600/60)) $((DEPLOY_DURATION%60)))
        
        echo "‚ùå URBANSEND DEPLOY FALHOU!"
        echo "=========================="
        echo "‚è±Ô∏è  Tempo at√© falha: $DURATION_FORMATTED"
        echo "üìä Status: FAILED ‚ùå"
        echo ""
        echo "üîç Coletando informa√ß√µes de diagn√≥stico UrbanSend..."
        
        # Coletar logs detalhados do UrbanSend
        sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
        echo 'üìã Containers UrbanSend em execu√ß√£o:'
        docker ps -a --filter 'name=urbansend'
        echo ''
        echo 'üìù Logs completos UrbanSend:'
        cd ${{ env.APP_DIR }} 2>/dev/null && docker-compose -f docker-compose.production.yml logs --tail=100 || echo 'N√£o foi poss√≠vel acessar logs do UrbanSend'
        echo ''
        echo 'üîç Portas UrbanSend:'
        netstat -tlnp | grep -E ':(${{ env.APP_PORT }}|${{ env.SMTP_PORT }}|${{ env.REDIS_PORT }})' || echo 'Nenhuma porta UrbanSend ativa'
        echo ''
        echo 'üíæ Uso de disco:'
        df -h
        echo ''
        echo 'üß† Uso de mem√≥ria:'
        free -h
        " 2>/dev/null || echo "N√£o foi poss√≠vel conectar √† VPS para diagn√≥stico"
        
        echo ""
        echo "üí•üí•üí• URBANSEND DEPLOY FALHOU - VERIFIQUE OS LOGS ACIMA üí•üí•üí•"
        
        exit 1