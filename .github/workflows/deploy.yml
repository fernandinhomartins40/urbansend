# ğŸš€ Direct VPS Deploy - UltraZend (Node.js direto, sem Docker/Nginx)
# Direct deployment to VPS with PM2 + Native SSL

name: ğŸš€ Deploy UltraZend Simple

on:
  push:
    branches: [main]
    paths-ignore: ['*.md', 'docs/**']
  workflow_dispatch:

env:
  VPS_HOST: 31.97.162.155
  VPS_USER: root
  DEPLOY_PATH: /var/www/ultrazend
  APP_DOMAIN: ultrazend.com.br

jobs:
  deploy:
    name: ğŸš€ Deploy Simplificado
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ==================== PREPARAÃ‡ÃƒO ====================
      - name: ğŸ“¥ 1ï¸âƒ£ Checkout & Setup
        uses: actions/checkout@v4
        
      - name: ğŸ”§ 2ï¸âƒ£ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ 3ï¸âƒ£ Build Application
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias do backend..."
          cd backend && npm ci
          
          echo "ğŸ—ï¸ Construindo backend..."
          npm run build
          
          echo "ğŸ“¦ Instalando dependÃªncias do frontend..."
          cd ../frontend && npm ci
          
          echo "ğŸ—ï¸ Construindo frontend..."
          npm run build
          
          echo "ğŸ“‹ Verificando se build foi criado..."
          ls -la dist/ || echo "âŒ Build do frontend falhou"
          
          echo "ğŸ“¦ Verificando conteÃºdo do index.html..."
          head -5 dist/index.html || echo "âŒ index.html nÃ£o encontrado"

      - name: ğŸ”§ 4ï¸âƒ£ Install SSH Tools
        run: |
          echo "ğŸ”§ Instalando ferramentas SSH..."
          sudo apt-get update -qq
          sudo apt-get install -y sshpass rsync
          
          echo "ğŸ” Testando conexÃ£o SSH..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            $VPS_USER@$VPS_HOST "echo 'âœ… SSH conectado com sucesso'"

      # ==================== PREPARAR VPS ====================
      - name: ğŸ› ï¸ 5ï¸âƒ£ Setup VPS Environment
        run: |
          echo "ğŸ› ï¸ Configurando ambiente da VPS..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'SCRIPT'
          set -e
          
          # Instalar Node.js se necessÃ¡rio
          if ! command -v node >/dev/null 2>&1; then
            echo "ğŸ“¦ Instalando Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
            apt-get install -y nodejs
          else
            echo "âœ… Node.js jÃ¡ instalado: $(node -v)"
          fi
          
          # Instalar PM2 globalmente
          if ! command -v pm2 >/dev/null 2>&1; then
            echo "ğŸ“¦ Instalando PM2..."
            npm install -g pm2
          else
            echo "âœ… PM2 jÃ¡ instalado"
          fi
          
          # Criar estrutura de diretÃ³rios
          echo "ğŸ“ Criando estrutura de diretÃ³rios..."
          mkdir -p /var/www/ultrazend/{backend,data,logs}
          chown -R www-data:www-data /var/www/ultrazend/data
          chmod 755 /var/www/ultrazend
          
          echo "âœ… VPS configurada"
          SCRIPT

      # ==================== UPLOAD FRONTEND BUILD ====================
      - name: ğŸš€ 5ï¸âƒ£ Upload Frontend Build
        run: |
          echo "ğŸ“¤ Enviando build do frontend para VPS..."
          
          # Upload frontend build
          sshpass -p "${{ secrets.VPS_PASSWORD }}" rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            frontend/dist/ $VPS_USER@$VPS_HOST:/var/www/ultrazend/frontend/
          
          echo "âœ… Frontend build enviado com sucesso"

      # ==================== DEPLOY APLICAÃ‡ÃƒO ====================
      - name: ğŸš€ 6ï¸âƒ£ Deploy Application
        run: |
          echo "ğŸš€ Fazendo deploy da aplicaÃ§Ã£o..."
          
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'DEPLOY'
          set -e
          
          # Navegar para diretÃ³rio da aplicaÃ§Ã£o
          cd /var/www/ultrazend
          
          # Parar aplicaÃ§Ã£o existente
          echo "ğŸ›‘ Parando aplicaÃ§Ã£o existente..."
          pm2 stop ultrazend 2>/dev/null || echo "Nenhuma aplicaÃ§Ã£o rodando"
          pm2 delete ultrazend 2>/dev/null || echo "Processo nÃ£o existia"
          
          # Garantir repositÃ³rio Git atualizado (preservando frontend build)
          echo "ğŸ”§ Configurando repositÃ³rio Git..."
          if [ ! -d ".git" ]; then
            echo "ğŸ“¥ Clonando repositÃ³rio (primeira vez)..."
            cd /var/www
            # Backup do frontend se existir
            if [ -d "ultrazend/frontend" ]; then
              mv ultrazend/frontend /tmp/frontend-backup
            fi
            rm -rf ultrazend
            git clone https://github.com/fernandinhomartins40/urbansend.git ultrazend
            cd ultrazend
            # Restaurar frontend build se havia backup
            if [ -d "/tmp/frontend-backup" ]; then
              rm -rf frontend
              mv /tmp/frontend-backup frontend
            fi
          else
            echo "ğŸ“¦ Atualizando cÃ³digo do repositÃ³rio..."
            # Backup do frontend build antes do reset
            cp -r frontend /tmp/frontend-backup || echo "Frontend nÃ£o existe ainda"
            git config --global --add safe.directory /var/www/ultrazend || true
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            # Restaurar frontend build
            rm -rf frontend
            mv /tmp/frontend-backup frontend || echo "Backup nÃ£o disponÃ­vel"
          fi
          
          # Ir para backend e configurar
          echo "âš™ï¸ Configurando backend..."
          cd backend
          
          # Instalar todas as dependÃªncias (incluindo dev para compilar)
          echo "ğŸ“¦ Instalando todas as dependÃªncias..."
          npm install
          
          # Compilar TypeScript
          echo "ğŸ”¨ Compilando TypeScript..."
          npm run build
          
          # Reinstalar sÃ³ dependÃªncias de produÃ§Ã£o
          echo "ğŸ§¹ Limpando devDependencies..."
          npm ci --only=production
          
          # Verificar frontend enviado via rsync
          cd /var/www/ultrazend
          echo "ğŸŒ Verificando frontend enviado..."
          
          # Verificar se arquivos do frontend foram recebidos corretamente
          if [ -f "frontend/index.html" ]; then
            echo "âœ… Frontend React encontrado:"
            ls -la frontend/index.html
            head -5 frontend/index.html
          else
            echo "âŒ Frontend nÃ£o foi enviado corretamente"
            mkdir -p frontend
            echo '{"error": "Frontend build nÃ£o encontrado"}' > frontend/error.json
          fi
          
          # Configurar permissÃµes do banco
          echo "ğŸ”§ Configurando permissÃµes..."
          mkdir -p /var/www/ultrazend/data
          touch /var/www/ultrazend/data/database.sqlite
          chown -R www-data:www-data /var/www/ultrazend/data/ || true
          chmod 664 /var/www/ultrazend/data/database.sqlite || true
          
          # Voltar para root da aplicaÃ§Ã£o
          cd /var/www/ultrazend
          
          # Iniciar aplicaÃ§Ã£o com PM2
          echo "â–¶ï¸ Iniciando aplicaÃ§Ã£o com PM2..."
          pm2 start ecosystem.config.js --env production
          
          # Salvar configuraÃ§Ã£o PM2
          pm2 save
          pm2 startup | tail -1 | bash || echo "PM2 startup jÃ¡ configurado"
          
          # Aguardar inicializaÃ§Ã£o
          echo "â³ Aguardando inicializaÃ§Ã£o (15s)..."
          sleep 15
          
          # Verificar status
          echo "ğŸ” Verificando status da aplicaÃ§Ã£o..."
          pm2 status
          
          # Verificar se aplicaÃ§Ã£o estÃ¡ online (com retry)
          echo "ğŸ” Verificando status da aplicaÃ§Ã£o (com retry)..."
          for i in {1..5}; do
            if pm2 list | grep -q "online"; then
              echo "âœ… AplicaÃ§Ã£o iniciada com sucesso (tentativa $i)"
              
              # Teste de conectividade
              echo "ğŸ” Testando conectividade..."
              if curl -f -s -m 10 http://localhost:3001/health > /dev/null; then
                echo "âœ… Health check passou"
              else
                echo "âš ï¸ Health check falhou, mas aplicaÃ§Ã£o estÃ¡ online"
              fi
              
              # Verificar portas
              echo "ğŸŒ Verificando portas..."
              netstat -tlnp | grep -E ':(80|443|3001)' || echo "Algumas portas nÃ£o estÃ£o escutando"
              break
            else
              echo "â³ Aguardando aplicaÃ§Ã£o ficar online (tentativa $i/5)..."
              if [ $i -eq 5 ]; then
                echo "âŒ Falha ao iniciar aplicaÃ§Ã£o apÃ³s 5 tentativas"
                echo "ğŸ“‹ Status PM2:"
                pm2 status
                echo "ğŸ“‹ Logs da aplicaÃ§Ã£o:"
                pm2 logs ultrazend --lines 20 --nostream || echo "Sem logs disponÃ­veis"
                echo "ğŸ“‹ Logs do sistema:"
                tail -n 10 /var/log/syslog | grep -i error || echo "Sem erros no syslog"
                exit 1
              fi
              sleep 3
            fi
          done
          
          echo "ğŸ‰ Deploy concluÃ­do com sucesso!"
          DEPLOY

      # ==================== RESUMO FINAL ====================
      - name: ğŸ“Š 7ï¸âƒ£ Summary
        run: |
          echo ""
          echo "ğŸ‰ ===== DEPLOY CONCLUÃDO COM SUCESSO ====="
          echo ""
          echo "ğŸ“‹ INFORMAÃ‡Ã•ES DO DEPLOY:"
          echo "  ğŸŒ DomÃ­nio: $APP_DOMAIN"
          echo "  ğŸ”Œ IP VPS: $VPS_HOST"
          echo "  ğŸšª HTTPS: Porta 443 (SSL nativo)"
          echo "  ğŸŒ HTTP: Porta 80 (redirect para HTTPS)"
          echo "  ğŸ“§ SMTP: Porta 25"
          echo "  â° Deploy: $(date '+%d/%m/%Y %H:%M:%S')"
          echo ""
          echo "ğŸ”— URLS DISPONÃVEIS:"
          echo "  ğŸŒ App: https://$APP_DOMAIN"
          echo "  ğŸ“± API: https://$APP_DOMAIN/api/"
          echo ""
          echo "ğŸ¯ ARQUITETURA SIMPLIFICADA:"
          echo "  âœ… Node.js direto com SSL nativo"
          echo "  âœ… PM2 process management (fork mode)"
          echo "  âœ… Sem Docker containers"
          echo "  âœ… Sem Nginx reverse proxy"
          echo "  âœ… Certificados Let's Encrypt diretos"
          echo ""
          echo "âœ… AplicaÃ§Ã£o UltraZend estÃ¡ online!"